var j=Object.defineProperty;var l=(r,t)=>j(r,"name",{value:t,configurable:!0});var B=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var A=(r,t,e)=>(B(r,t,"read from private field"),e?e.call(r):t.get(r)),v=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},D=(r,t,e,s)=>(B(r,t,"write to private field"),s?s.call(r,e):t.set(r,e),e);var K=(r,t,e)=>(B(r,t,"access private method"),e);var d=(r,t,e)=>new Promise((s,n)=>{var o=c=>{try{i(e.next(c))}catch(u){n(u)}},a=c=>{try{i(e.throw(c))}catch(u){n(u)}},i=c=>c.done?s(c.value):Promise.resolve(c.value).then(o,a);i((e=e.apply(r,t)).next())});function L(r){if(r.length%4!==0)throw new Error("Unable to parse base64 string (invalid length).");let t=r.indexOf("=");if(t!==-1&&t<r.length-2)throw new Error("Unable to parse base64 string (octets).");let e=r.endsWith("==")?2:r.endsWith("=")?1:0,s=r.length,n=new Uint8Array(3*(s/4)),o;for(let a=0,i=0;a<s;a+=4,i+=3)o=E(r.charCodeAt(a))<<18|E(r.charCodeAt(a+1))<<12|E(r.charCodeAt(a+2))<<6|E(r.charCodeAt(a+3)),n[i]=o>>16,n[i+1]=o>>8&255,n[i+2]=o&255;return n.subarray(0,n.length-e)}l(L,"base64ToBytes");var f=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","_","-"],T=(()=>{let t=new Uint8Array(256);for(let e=0;e<256;++e)t[e]=255;return f.forEach((e,s)=>{t[e.charCodeAt(0)]=s}),t["=".charCodeAt(0)]=0,t})();function E(r){if(r>=T.length)throw new Error("Unable to parse base64 string (code beyond length).");let t=T[r];if(t===255)throw new Error("Unable to parse base64 string (invalid code).");return t}l(E,"getBase64Code");function q(r){let t="",e,s=r.length;for(e=2;e<s;e+=3)t+=f[r[e-2]>>2],t+=f[(r[e-2]&3)<<4|r[e-1]>>4],t+=f[(r[e-1]&15)<<2|r[e]>>6],t+=f[r[e]&63];return e===s+1&&(t+=f[r[e-2]>>2],t+=f[(r[e-2]&3)<<4],t+="=="),e===s&&(t+=f[r[e-2]>>2],t+=f[(r[e-2]&3)<<4|r[e-1]>>4],t+=f[(r[e-1]&15)<<2],t+="="),t}l(q,"bytesToBase64");var O=l(r=>{let t=new TextEncoder;return window.crypto.subtle.importKey("raw",t.encode(r),"PBKDF2",!1,["deriveKey"])},"getPasswordKey"),U=l((r,t,e)=>window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:25e4,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,e),"deriveKey");function R(r,t){return d(this,null,function*(){try{let e=window.crypto.getRandomValues(new Uint8Array(16)),s=window.crypto.getRandomValues(new Uint8Array(12)),n=yield O(t),o=yield U(n,e,["encrypt"]),a=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},o,new TextEncoder().encode(r)),i=new Uint8Array(a),c=new Uint8Array(e.byteLength+s.byteLength+i.byteLength);return c.set(e,0),c.set(s,e.byteLength),c.set(i,e.byteLength+s.byteLength),q(c)}catch(e){throw console.log(`Encryption Error - ${e}`),e}})}l(R,"encryptData");function I(r,t){return d(this,null,function*(){try{let e=L(r),s=e.slice(0,16),n=e.slice(16,16+12),o=e.slice(16+12),a=yield O(t),i=yield U(a,s,["decrypt"]),c=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},i,o);return new TextDecoder().decode(c)}catch(e){throw console.log(`Decryption Error - ${e}`),e}})}l(I,"decryptData");var m,V,h=class{constructor(t){v(this,m);this.db=null,t&&K(this,m,V).call(this).then(e=>{typeof t=="function"&&t(e)}).catch(e=>{throw console.log(e),e})}initialize(){return new Promise((t,e)=>{K(this,m,V).call(this).then(s=>{t(s)}).catch(s=>{console.log(s),e(s)})})}openCatalog(){let t=indexedDB.open("SylvieCatalog",1);return t.onupgradeneeded=({target:e})=>{let s=e.result;if(s.objectStoreNames.contains("SylvieAKV")&&s.deleteObjectStore("SylvieAKV"),!s.objectStoreNames.contains("SylvieAKV")){let n=s.createObjectStore("SylvieAKV",{keyPath:"id",autoIncrement:!0});n.createIndex("app","app",{unique:!1}),n.createIndex("key","key",{unique:!1}),n.createIndex("appkey","appkey",{unique:!0})}},t}getAppKeyAsync(t,e){return d(this,null,function*(){let o=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("appkey"),a=`${t},${e}`,i=o.get(a);return new Promise((c,u)=>{i.onsuccess=({target:g})=>{let y=g.result;(y===null||typeof y=="undefined")&&(y={id:0,success:!1}),c(y)},i.onerror=g=>{u(g)}})})}setAppKeyAsync(t,e,s){return d(this,null,function*(){let o=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV"),a=o.index("appkey"),i=`${t},${e}`,c=a.get(i);return new Promise((u,g)=>{c.onsuccess=({target:y})=>{let b=y.result;b==null?b={app:t,key:e,appkey:`${t},${e}`,val:s}:b.val=s;let C=o.put(b);C.onerror=()=>{g({success:!1,error:C.error}),console.error("SylvieCatalog.setAppKey (set) onerror"),console.error(c.error)},C.onsuccess=()=>{u({success:!0})}},c.onerror=()=>{g({success:!1,error:c.error}),console.error("SylvieCatalog.setAppKey (get) onerror"),console.error(c.error)}})})}deleteAppKeyAsync(t){let n=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV").delete(t);return new Promise((o,a)=>{n.onsuccess=()=>{o({success:!0})},n.onerror=i=>{a({success:!1,error:i}),console.error("SylvieCatalog.deleteAppKey raised onerror"),console.error(n.error)}})}getAppKeys(t,e){let o=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("app"),a=IDBKeyRange.only(t),i=o.openCursor(a),c=[];i.onsuccess=((u,g)=>()=>{let y=i.result;if(y){let b=y.value;u.push(b),y.continue()}else typeof g=="function"?g(u):console.log(u)})(c,e),i.onerror=(u=>g=>{typeof u=="function"?u(null):(console.error("SylvieCatalog.getAppKeys raised onerror"),console.error(g))})(e)}getAllKeys(t){let n=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").openCursor(),o=[];n.onsuccess=((a,i)=>()=>{let c=n.result;if(c){let u=c.value;a.push(u),c.continue()}else typeof i=="function"?i(a):console.log(a)})(o,t),n.onerror=(a=>i=>{typeof a=="function"&&a(null)})(t)}};l(h,"SylvieCatalog"),m=new WeakSet,V=l(function(){return d(this,null,function*(){let t=this,e=this.openCatalog();return new Promise((s,n)=>{e.onsuccess=({target:o})=>{t.db=o.result,s(t)},e.onerror=o=>{n(o)}})})},"#initializeCatalog");var w=typeof window!="undefined"&&!!window.__loki_idb_debug;w&&console.log("DEBUG: Running crypted-indexeddb-adapter in DEBUG mode");if(!window.crypto.subtle)throw alert("Required crypto lib is not availible, are you using SSL?"),new Error("Required crypto lib is not availible");var p,S,P,$,x=class{constructor(t){v(this,P);v(this,p,void 0);v(this,S,l(()=>{this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},"#closeDatabase"));this.loadDatabase=l((t,e)=>{if(w&&console.debug("loading database"),this.catalog===null||this.catalog.db===null){this.catalog=new h(s=>{this.catalog=s,this.loadDatabase(t,e)});try{this.catalog.initialize().then(s=>{this.catalog=s})}catch(s){console.log(s)}return}this.catalog.getAppKeyAsync(this.app,t).then(s=>{let{success:n}=s;if(n===!1){e(null);return}else{let{val:o}=s;typeof e=="function"?I(o,A(this,p)).then(i=>{w&&console.debug(`DECRYPTED STRING: ${i}`),e(i)}).catch(i=>{e(i)}):console.log(o)}})},"loadDatabase");this.loadDatabaseAsync=l(t=>d(this,null,function*(){return w&&console.debug("loading database"),new Promise((e,s)=>{if(this.catalog===null||this.catalog.db===null){this.catalog.initialize().then(n=>{this.catalog=n,this.loadDatabase(t,o=>e(o))});return}this.catalog.getAppKeyAsync(this.app,t).then(n=>{let{success:o}=n;if(o===!1)s(null);else{let{val:a}=n;I(a,A(this,p)).then(c=>{w&&console.debug(`DECRYPTED STRING: ${c}`),e(c)}).catch(c=>{s(c)})}})})}),"loadDatabaseAsync");this.saveDatabase=l((t,e,s)=>{w&&console.debug(`in saveDatabase(${t}, ${e}, ${s})`);let n=l(o=>{o==null||typeof o=="object"&&Object.hasOwn(o,"success")&&o&&o.success===!0?s(void 0):s(new Error("Error saving database: "+o)),this.options.closeAfterSave===!0&&A(this,S).call(this)},"saveCallback");if(this.catalog===null||this.catalog.db===null){this.catalog=new h(()=>{this.saveDatabase(t,e,n)});return}R(e,A(this,p)).then(o=>{w&&console.debug(`ENCRYPTED STRING: ${o}`),this.catalog.setAppKeyAsync(this.app,t,o).then(a=>{s(a)}).catch(a=>{s(a)})}).catch(o=>{s(o)})},"saveDatabase");this.deleteDatabase=l((t,e)=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new h(s=>{this.catalog=s,this.deleteDatabase(t,e)});return}this.catalog.getAppKeyAsync(this.app,t).then(s=>{let n=s.id;n!==0&&this.catalog.deleteAppKeyAsync(n).then(o=>{typeof e=="function"&&e(o)}).catch(o=>{typeof e=="function"&&e({success:!1,error:o})})}).catch(s=>{typeof e=="function"&&e({success:!1,error:s})})},"deleteDatabase");this.deleteDatabasePartitions=l(t=>{this.getDatabaseList(e=>{e.forEach(s=>{s.startsWith(t)&&this.deleteDatabase(s)})})},"deleteDatabasePartitions");this.getDatabaseList=l(t=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new h(e=>{this.catalog=e,this.getDatabaseList(t)});return}this.catalog.getAppKeys(this.app,e=>{let s=[];for(let n=0;n<e.length;n++)s.push(e[n].key);typeof t=="function"?t(s):s.forEach(n=>{console.log(n)})})},"getDatabaseList");this.getDatabaseListAsync=l(()=>new Promise((t,e)=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new h(s=>{this.catalog=s,this.getDatabaseListAsync()});return}this.catalog.getAppKeys(this.app,s=>{let n=[];for(let o=0;o<s.length;o++)n.push(s[o].key);t(n)})}),"getDatabaseListAsync");this.getCatalogSummary=l(t=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new h(e=>{this.catalog=e,this.getCatalogSummary(t)});return}this.catalog.getAllKeys(e=>{let s=[],n,o,a,i,c;for(let u=0;u<e.length;u++)n=e[u],a=n.app||"",i=n.key||"",c=n.val||"",o=a.length*2+i.length*2+c.length+1,s.push({app:n.app,key:n.key,size:o});typeof t=="function"?t(s):s.forEach(u=>{console.log(u)})})},"getCatalogSummary");if(w&&console.log("Initialized crypted-indexeddb-adapter"),this.app="sylvie",this.options=t||{},typeof(t==null?void 0:t.appname)!="undefined"&&(this.app=t==null?void 0:t.appname),this.catalog=null,!K(this,P,$).call(this))throw new Error("IndexedDB does not seem to be supported for your environment");t.secret&&D(this,p,t.secret)}usePassword(t){D(this,p,t)}saveDatabaseAsync(t,e){return d(this,null,function*(){return new Promise((s,n)=>{let o=l(a=>{a==null||typeof a=="object"&&Object.hasOwn(a,"success")&&a&&a.success===!0?s(void 0):n(new Error("Error saving database: "+a)),this.options.closeAfterSave===!0&&A(this,S).call(this)},"saveCallback");if(this.catalog===null||this.catalog.db===null){this.catalog=new h(()=>{this.saveDatabase(t,e,o)});return}R(e,A(this,p)).then(a=>{w&&console.debug(`ENCRYPTED STRING: ${a}`),this.catalog.setAppKeyAsync(this.app,t,a).then(i=>{i.success===!0?s(i):n(i)}).catch(i=>{n(i)})}).catch(a=>{n(a)})})})}deleteDatabaseAsync(t){return d(this,null,function*(){return new Promise((e,s)=>{(this.catalog===null||this.catalog.db===null)&&(this.catalog=new h(n=>(this.catalog=n,this.deleteDatabaseAsync(t)))),this.catalog.getAppKeyAsync(this.app,t).then(n=>{let o=n.id;o!==0&&this.catalog.deleteAppKeyAsync(o).then(a=>{a.success===!0?e(a):s(a)}).catch(a=>{s(a)})}).catch(n=>{s(n)})})})}changePassword(t,e){return d(this,null,function*(){return new Promise((s,n)=>{this.loadDatabase(t,o=>{let a=A(this,p);D(this,p,e),this.saveDatabase(t,o,i=>{i&&(D(this,p,a),i.success===!0?s():n(i)),s()})})})})}};l(x,"CryptedIndexedDBAdapter"),p=new WeakMap,S=new WeakMap,P=new WeakSet,$=l(function(){return!!(typeof indexedDB!="undefined"&&indexedDB)},"#checkIDBAvailability");typeof window!="undefined"&&Object.assign(window,{IndexedDBAdapter:x,CryptedIndexedDBAdapter:x});export{x as CryptedIndexedDBAdapter};
//# sourceMappingURL=crypted-indexeddb-adapter.js.map
