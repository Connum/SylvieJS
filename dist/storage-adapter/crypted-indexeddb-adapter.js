var L=Object.defineProperty;var d=(o,t)=>L(o,"name",{value:t,configurable:!0});var C=(o,t,e)=>{if(!t.has(o))throw TypeError("Cannot "+e)};var b=(o,t,e)=>(C(o,t,"read from private field"),e?e.call(o):t.get(o)),K=(o,t,e)=>{if(t.has(o))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(o):t.set(o,e)},v=(o,t,e,s)=>(C(o,t,"write to private field"),s?s.call(o,e):t.set(o,e),e);var P=(o,t,e)=>(C(o,t,"access private method"),e);var f=(o,t,e)=>new Promise((s,n)=>{var r=c=>{try{a(e.next(c))}catch(l){n(l)}},i=c=>{try{a(e.throw(c))}catch(l){n(l)}},a=c=>c.done?s(c.value):Promise.resolve(c.value).then(r,i);a((e=e.apply(o,t)).next())});function O(o){if(o.length%4!==0)throw new Error("Unable to parse base64 string (invalid length).");let t=o.indexOf("=");if(t!==-1&&t<o.length-2)throw new Error("Unable to parse base64 string (octets).");let e=o.endsWith("==")?2:o.endsWith("=")?1:0,s=o.length,n=new Uint8Array(3*(s/4)),r;for(let i=0,a=0;i<s;i+=4,a+=3)r=D(o.charCodeAt(i))<<18|D(o.charCodeAt(i+1))<<12|D(o.charCodeAt(i+2))<<6|D(o.charCodeAt(i+3)),n[a]=r>>16,n[a+1]=r>>8&255,n[a+2]=r&255;return n.subarray(0,n.length-e)}d(O,"base64ToBytes");var y=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","_","-"],B=(()=>{let t=new Uint8Array(256);for(let e=0;e<256;++e)t[e]=255;return y.forEach((e,s)=>{t[e.charCodeAt(0)]=s}),t["=".charCodeAt(0)]=0,t})();function D(o){if(o>=B.length)throw new Error("Unable to parse base64 string (code beyond length).");let t=B[o];if(t===255)throw new Error("Unable to parse base64 string (invalid code).");return t}d(D,"getBase64Code");function $(o){let t="",e,s=o.length;for(e=2;e<s;e+=3)t+=y[o[e-2]>>2],t+=y[(o[e-2]&3)<<4|o[e-1]>>4],t+=y[(o[e-1]&15)<<2|o[e]>>6],t+=y[o[e]&63];return e===s+1&&(t+=y[o[e-2]>>2],t+=y[(o[e-2]&3)<<4],t+="=="),e===s&&(t+=y[o[e-2]>>2],t+=y[(o[e-2]&3)<<4|o[e-1]>>4],t+=y[(o[e-1]&15)<<2],t+="="),t}d($,"bytesToBase64");var j=d(o=>{let t=new TextEncoder;return window.crypto.subtle.importKey("raw",t.encode(o),"PBKDF2",!1,["deriveKey"])},"getPasswordKey"),V=d((o,t,e)=>window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:25e4,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,e),"deriveKey");function I(o,t){return f(this,null,function*(){try{let e=window.crypto.getRandomValues(new Uint8Array(16)),s=window.crypto.getRandomValues(new Uint8Array(12)),n=yield j(t),r=yield V(n,e,["encrypt"]),i=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},r,new TextEncoder().encode(o)),a=new Uint8Array(i),c=new Uint8Array(e.byteLength+s.byteLength+a.byteLength);return c.set(e,0),c.set(s,e.byteLength),c.set(a,e.byteLength+s.byteLength),$(c)}catch(e){throw console.log(`Encryption Error - ${e}`),e}})}d(I,"encryptData");function U(o,t){return f(this,null,function*(){try{let e=O(o),s=e.slice(0,16),n=e.slice(16,16+12),r=e.slice(16+12),i=yield j(t),a=yield V(i,s,["decrypt"]),c=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},a,r);return new TextDecoder().decode(c)}catch(e){throw console.log(`Decryption Error - ${e}`),e}})}d(U,"decryptData");var g=class{constructor(t){this.db=null,this.initializeCatalog().then(e=>{typeof t=="function"&&t(e)}).catch(e=>{throw console.log(e),e})}openCatalog(){let t=indexedDB.open("SylvieCatalog",1);return t.onupgradeneeded=({target:e})=>{let s=e.result;if(s.objectStoreNames.contains("SylvieAKV")&&s.deleteObjectStore("SylvieAKV"),!s.objectStoreNames.contains("SylvieAKV")){let n=s.createObjectStore("SylvieAKV",{keyPath:"id",autoIncrement:!0});n.createIndex("app","app",{unique:!1}),n.createIndex("key","key",{unique:!1}),n.createIndex("appkey","appkey",{unique:!0})}},t}initializeCatalog(){return f(this,null,function*(){let t=this,e=this.openCatalog();return new Promise((s,n)=>{e.onsuccess=({target:r})=>{t.db=r.result,s(t)},e.onerror=r=>{n(r)}})})}getAppKeyAsync(t,e){return f(this,null,function*(){let r=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("appkey"),i=`${t},${e}`,a=r.get(i);return new Promise((c,l)=>{a.onsuccess=({target:u})=>{let p=u.result;(p===null||typeof p=="undefined")&&(p={id:0,success:!1}),c(p)},a.onerror=u=>{l(u)}})})}setAppKeyAsync(t,e,s){return f(this,null,function*(){let r=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV"),i=r.index("appkey"),a=`${t},${e}`,c=i.get(a);return new Promise((l,u)=>{c.onsuccess=({target:p})=>{let w=p.result;w==null?w={app:t,key:e,appkey:`${t},${e}`,val:s}:w.val=s;let E=r.put(w);E.onerror=()=>{u({success:!1,error:E.error}),console.error("SylvieCatalog.setAppKey (set) onerror"),console.error(c.error)},E.onsuccess=()=>{l({success:!0})}},c.onerror=()=>{u({success:!1,error:c.error}),console.error("SylvieCatalog.setAppKey (get) onerror"),console.error(c.error)}})})}deleteAppKeyAsync(t){let n=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV").delete(t);return new Promise((r,i)=>{n.onsuccess=()=>{r({success:!0})},n.onerror=a=>{i({success:!1,error:a}),console.error("SylvieCatalog.deleteAppKey raised onerror"),console.error(n.error)}})}getAppKeys(t,e){let r=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("app"),i=IDBKeyRange.only(t),a=r.openCursor(i),c=[];a.onsuccess=((l,u)=>()=>{let p=a.result;if(p){let w=p.value;l.push(w),p.continue()}else typeof u=="function"?u(l):console.log(l)})(c,e),a.onerror=(l=>u=>{typeof l=="function"?l(null):(console.error("SylvieCatalog.getAppKeys raised onerror"),console.error(u))})(e)}getAllKeys(t){let n=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").openCursor(),r=[];n.onsuccess=((i,a)=>()=>{let c=n.result;if(c){let l=c.value;i.push(l),c.continue()}else typeof a=="function"?a(i):console.log(i)})(r,t),n.onerror=(i=>a=>{typeof i=="function"&&i(null)})(t)}};d(g,"SylvieCatalog");var A=typeof window!="undefined"&&!!window.__loki_idb_debug;A&&console.log("DEBUG: Running crypted-indexeddb-adapter in DEBUG mode");if(!window.crypto.subtle)throw alert("Required crypto lib is not availible, are you using SSL?"),new Error("Required crypto lib is not availible");var h,m,S,R,x=class{constructor(t){K(this,S);K(this,h,void 0);K(this,m,d(()=>{this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},"#closeDatabase"));this.loadDatabase=d((t,e)=>{if(A&&console.debug("loading database"),this.catalog===null||this.catalog.db===null){this.catalog=new g(s=>{this.catalog=s,this.loadDatabase(t,e)});return}this.catalog.getAppKeyAsync(this.app,t).then(s=>{let{success:n}=s;if(n===!1){e(null);return}else{let{val:r}=s;typeof e=="function"?U(r,b(this,h)).then(a=>{A&&console.debug(`DECRYPTED STRING: ${a}`),e(a)}).catch(a=>{e(a)}):console.log(r)}})},"loadDatabase");this.saveDatabase=d((t,e,s)=>{A&&console.debug(`in saveDatabase(${t}, ${e}, ${s})`);let n=d(r=>{r==null||typeof r=="object"&&Object.hasOwn(r,"success")&&r&&r.success===!0?s(void 0):s(new Error("Error saving database: "+r)),this.options.closeAfterSave===!0&&b(this,m).call(this)},"saveCallback");if(this.catalog===null||this.catalog.db===null){this.catalog=new g(()=>{this.saveDatabase(t,e,n)});return}I(e,b(this,h)).then(r=>{A&&console.debug(`ENCRYPTED STRING: ${r}`),this.catalog.setAppKeyAsync(this.app,t,r).then(i=>{s(i)}).catch(i=>{s(i)})}).catch(r=>{s(r)})},"saveDatabase");this.deleteDatabase=d((t,e)=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new g(s=>{this.catalog=s,this.deleteDatabase(t,e)});return}this.catalog.getAppKeyAsync(this.app,t).then(s=>{let n=s.id;n!==0&&this.catalog.deleteAppKeyAsync(n).then(r=>{typeof e=="function"&&e(r)}).catch(r=>{typeof e=="function"&&e({success:!1,error:r})})}).catch(s=>{typeof e=="function"&&e({success:!1,error:s})})},"deleteDatabase");this.deleteDatabasePartitions=d(t=>{this.getDatabaseList(e=>{e.forEach(s=>{s.startsWith(t)&&this.deleteDatabase(s)})})},"deleteDatabasePartitions");this.getDatabaseList=d(t=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new g(e=>{this.catalog=e,this.getDatabaseList(t)});return}this.catalog.getAppKeys(this.app,e=>{let s=[];for(let n=0;n<e.length;n++)s.push(e[n].key);typeof t=="function"?t(s):s.forEach(n=>{console.log(n)})})},"getDatabaseList");this.getDatabaseListAsync=d(()=>new Promise((t,e)=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new g(s=>{this.catalog=s,this.getDatabaseListAsync()});return}this.catalog.getAppKeys(this.app,s=>{let n=[];for(let r=0;r<s.length;r++)n.push(s[r].key);t(n)})}),"getDatabaseListAsync");this.getCatalogSummary=d(t=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new g(e=>{this.catalog=e,this.getCatalogSummary(t)});return}this.catalog.getAllKeys(e=>{let s=[],n,r,i,a,c;for(let l=0;l<e.length;l++)n=e[l],i=n.app||"",a=n.key||"",c=n.val||"",r=i.length*2+a.length*2+c.length+1,s.push({app:n.app,key:n.key,size:r});typeof t=="function"?t(s):s.forEach(l=>{console.log(l)})})},"getCatalogSummary");if(A&&console.log("Initialized crypted-indexeddb-adapter"),this.app="sylvie",this.options=t||{},typeof(t==null?void 0:t.appname)!="undefined"&&(this.app=t==null?void 0:t.appname),this.catalog=null,!P(this,S,R).call(this))throw new Error("IndexedDB does not seem to be supported for your environment");t.secret&&v(this,h,t.secret)}usePassword(t){v(this,h,t)}changePassword(t,e){return f(this,null,function*(){return new Promise((s,n)=>{this.loadDatabase(t,r=>{let i=b(this,h);v(this,h,e),this.saveDatabase(t,r,a=>{a&&(v(this,h,i),a.success===!0?s():n(a)),s()})})})})}};d(x,"CryptedIndexedDBAdapter"),h=new WeakMap,m=new WeakMap,S=new WeakSet,R=d(function(){return!!(typeof indexedDB!="undefined"&&indexedDB)},"#checkIDBAvailability");typeof window!="undefined"&&Object.assign(window,{IndexedDBAdapter:x,CryptedIndexedDBAdapter:x});export{x as CryptedIndexedDBAdapter};
//# sourceMappingURL=crypted-indexeddb-adapter.js.map
