var z=Object.defineProperty;var l=(i,t)=>z(i,"name",{value:t,configurable:!0});var B=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var A=(i,t,e)=>(B(i,t,"read from private field"),e?e.call(i):t.get(i)),v=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},m=(i,t,e,s)=>(B(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e);var S=(i,t,e)=>(B(i,t,"access private method"),e);var h=(i,t,e)=>new Promise((s,o)=>{var r=c=>{try{n(e.next(c))}catch(d){o(d)}},a=c=>{try{n(e.throw(c))}catch(d){o(d)}},n=c=>c.done?s(c.value):Promise.resolve(c.value).then(r,a);n((e=e.apply(i,t)).next())});function L(i){if(i.length%4!==0)throw new Error("Unable to parse base64 string (invalid length).");let t=i.indexOf("=");if(t!==-1&&t<i.length-2)throw new Error("Unable to parse base64 string (octets).");let e=i.endsWith("==")?2:i.endsWith("=")?1:0,s=i.length,o=new Uint8Array(3*(s/4)),r;for(let a=0,n=0;a<s;a+=4,n+=3)r=E(i.charCodeAt(a))<<18|E(i.charCodeAt(a+1))<<12|E(i.charCodeAt(a+2))<<6|E(i.charCodeAt(a+3)),o[n]=r>>16,o[n+1]=r>>8&255,o[n+2]=r&255;return o.subarray(0,o.length-e)}l(L,"base64ToBytes");var f=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","_","-"],T=(()=>{let t=new Uint8Array(256);for(let e=0;e<256;++e)t[e]=255;return f.forEach((e,s)=>{t[e.charCodeAt(0)]=s}),t["=".charCodeAt(0)]=0,t})();function E(i){if(i>=T.length)throw new Error("Unable to parse base64 string (code beyond length).");let t=T[i];if(t===255)throw new Error("Unable to parse base64 string (invalid code).");return t}l(E,"getBase64Code");function q(i){let t="",e,s=i.length;for(e=2;e<s;e+=3)t+=f[i[e-2]>>2],t+=f[(i[e-2]&3)<<4|i[e-1]>>4],t+=f[(i[e-1]&15)<<2|i[e]>>6],t+=f[i[e]&63];return e===s+1&&(t+=f[i[e-2]>>2],t+=f[(i[e-2]&3)<<4],t+="=="),e===s&&(t+=f[i[e-2]>>2],t+=f[(i[e-2]&3)<<4|i[e-1]>>4],t+=f[(i[e-1]&15)<<2],t+="="),t}l(q,"bytesToBase64");var O=l(i=>{let t=new TextEncoder;return window.crypto.subtle.importKey("raw",t.encode(i),"PBKDF2",!1,["deriveKey"])},"getPasswordKey"),U=l((i,t,e)=>window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:25e4,hash:"SHA-256"},i,{name:"AES-GCM",length:256},!1,e),"deriveKey");function R(i,t){return h(this,null,function*(){try{let e=window.crypto.getRandomValues(new Uint8Array(16)),s=window.crypto.getRandomValues(new Uint8Array(12)),o=yield O(t),r=yield U(o,e,["encrypt"]),a=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},r,new TextEncoder().encode(i)),n=new Uint8Array(a),c=new Uint8Array(e.byteLength+s.byteLength+n.byteLength);return c.set(e,0),c.set(s,e.byteLength),c.set(n,e.byteLength+s.byteLength),q(c)}catch(e){throw console.log(`Encryption Error - ${e}`),e}})}l(R,"encryptData");function I(i,t){return h(this,null,function*(){try{let e=L(i),s=e.slice(0,16),o=e.slice(16,16+12),r=e.slice(16+12),a=yield O(t),n=yield U(a,s,["decrypt"]),c=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:o},n,r);return new TextDecoder().decode(c)}catch(e){throw console.log(`Decryption Error - ${e}`),e}})}l(I,"decryptData");var D,V,u=class{constructor(t){v(this,D);this.db=null,t&&S(this,D,V).call(this).then(e=>{typeof t=="function"&&t(e)}).catch(e=>{throw console.log(e),e})}initialize(){return new Promise((t,e)=>{S(this,D,V).call(this).then(s=>{t(s)}).catch(s=>{console.log(s),e(s)})})}openCatalog(){let t=indexedDB.open("SylvieCatalog",1);return t.onupgradeneeded=({target:e})=>{let s=e.result;if(s.objectStoreNames.contains("SylvieAKV")&&s.deleteObjectStore("SylvieAKV"),!s.objectStoreNames.contains("SylvieAKV")){let o=s.createObjectStore("SylvieAKV",{keyPath:"id",autoIncrement:!0});o.createIndex("app","app",{unique:!1}),o.createIndex("key","key",{unique:!1}),o.createIndex("appkey","appkey",{unique:!0})}},t}getAppKeyAsync(t,e){return h(this,null,function*(){let r=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("appkey"),a=`${t},${e}`,n=r.get(a);return new Promise((c,d)=>{n.onsuccess=({target:y})=>{let g=y.result;(g===null||typeof g=="undefined")&&(g={id:0,success:!1}),c(g)},n.onerror=y=>{d(y)}})})}setAppKeyAsync(t,e,s){return h(this,null,function*(){let r=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV"),a=r.index("appkey"),n=`${t},${e}`,c=a.get(n);return new Promise((d,y)=>{c.onsuccess=({target:g})=>{let b=g.result;b==null?b={app:t,key:e,appkey:`${t},${e}`,val:s}:b.val=s;let C=r.put(b);C.onerror=()=>{y({success:!1,error:C.error}),console.error("SylvieCatalog.setAppKey (set) onerror"),console.error(c.error)},C.onsuccess=()=>{d({success:!0})}},c.onerror=()=>{y({success:!1,error:c.error}),console.error("SylvieCatalog.setAppKey (get) onerror"),console.error(c.error)}})})}deleteAppKeyAsync(t){let o=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV").delete(t);return new Promise((r,a)=>{o.onsuccess=()=>{r({success:!0})},o.onerror=n=>{a({success:!1,error:n}),console.error("SylvieCatalog.deleteAppKey raised onerror"),console.error(o.error)}})}getAppKeys(t,e){let r=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("app"),a=IDBKeyRange.only(t),n=r.openCursor(a),c=[];n.onsuccess=((d,y)=>()=>{let g=n.result;if(g){let b=g.value;d.push(b),g.continue()}else typeof y=="function"?y(d):console.log(d)})(c,e),n.onerror=(d=>y=>{typeof d=="function"?d(null):(console.error("SylvieCatalog.getAppKeys raised onerror"),console.error(y))})(e)}getAllKeys(t){let o=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").openCursor(),r=[];o.onsuccess=((a,n)=>()=>{let c=o.result;if(c){let d=c.value;a.push(d),c.continue()}else typeof n=="function"?n(a):console.log(a)})(r,t),o.onerror=(a=>n=>{typeof a=="function"&&a(null)})(t)}};l(u,"SylvieCatalog"),D=new WeakSet,V=l(function(){return h(this,null,function*(){let t=this,e=this.openCatalog();return new Promise((s,o)=>{e.onsuccess=({target:r})=>{t.db=r.result,s(t)},e.onerror=r=>{o(r)}})})},"#initializeCatalog");var w=typeof window!="undefined"&&!!window.__loki_idb_debug;w&&console.log("DEBUG: Running crypted-indexeddb-adapter in DEBUG mode");if(!window.crypto.subtle)throw alert("Required crypto lib is not availible, are you using SSL?"),new Error("Required crypto lib is not availible");var p,x,P,$,K=class{constructor(t){v(this,P);v(this,p,void 0);v(this,x,l(()=>{this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},"#closeDatabase"));this.loadDatabase=l((t,e)=>{if(w&&console.debug("loading database"),this.catalog===null||this.catalog.db===null){new u().initialize().then(s=>{this.catalog=s,this.loadDatabase(t,e)});return}this.catalog.getAppKeyAsync(this.app,t).then(s=>{let{success:o}=s;if(o===!1)e(null);else{let{val:r}=s;I(r,A(this,p)).then(a=>{w&&console.debug(`DECRYPTED STRING: ${a}`),e(a)}).catch(a=>{console.error(a),e(a)})}}).catch(s=>{console.error(s),e(s)})},"loadDatabase");this.loadDatabaseAsync=l(t=>h(this,null,function*(){return w&&console.debug("loading database"),new Promise((e,s)=>{let o=l(()=>this.catalog.getAppKeyAsync(this.app,t).then(r=>{let{success:a}=r;if(a===!1)s(null);else{let{val:n}=r;I(n,A(this,p)).then(d=>{w&&console.debug(`DECRYPTED STRING: ${d}`),e(d)}).catch(d=>{s(d)})}}),"doLoad");this.catalog===null||this.catalog.db===null?new u().initialize().then(r=>{this.catalog=r,o()}).catch(r=>{s(r)}):o()})}),"loadDatabaseAsync");this.saveDatabase=l((t,e,s)=>{w&&console.debug(`in saveDatabase(${t}, ${e}, ${s})`);let o=l(()=>R(e,A(this,p)).then(a=>{w&&console.debug(`ENCRYPTED STRING: ${a}`),this.catalog.setAppKeyAsync(this.app,t,a).then(n=>{s(n)}).catch(n=>{s(n)})}).catch(a=>{s(a)}),"doSave"),r=l(a=>{a==null||typeof a=="object"&&Object.hasOwn(a,"success")&&a&&a.success===!0?s(void 0):s(new Error("Error saving database: "+a)),this.options.closeAfterSave===!0&&A(this,x).call(this)},"afterSaveCallback");this.catalog===null||this.catalog.db===null?new u().initialize().then(a=>{this.catalog=a,this.saveDatabaseAsync(t,e).then(n=>{r(n)}).catch(n=>{r(n)})}).catch(a=>{r(a)}):o()},"saveDatabase");this.deleteDatabase=l((t,e)=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new u(s=>{this.catalog=s,this.deleteDatabase(t,e)});return}this.catalog.getAppKeyAsync(this.app,t).then(s=>{let o=s.id;o!==0&&this.catalog.deleteAppKeyAsync(o).then(r=>{typeof e=="function"&&e(r)}).catch(r=>{typeof e=="function"&&e({success:!1,error:r})})}).catch(s=>{typeof e=="function"&&e({success:!1,error:s})})},"deleteDatabase");this.deleteDatabasePartitions=l(t=>{this.getDatabaseList(e=>{e.forEach(s=>{s.startsWith(t)&&this.deleteDatabase(s)})})},"deleteDatabasePartitions");this.getDatabaseList=l(t=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new u(e=>{this.catalog=e,this.getDatabaseList(t)});return}this.catalog.getAppKeys(this.app,e=>{let s=[];for(let o=0;o<e.length;o++)s.push(e[o].key);typeof t=="function"?t(s):s.forEach(o=>{console.log(o)})})},"getDatabaseList");this.getDatabaseListAsync=l(()=>new Promise((t,e)=>{this.catalog===null||this.catalog.db===null?new u().initialize().then(s=>{this.catalog=s,this.catalog.getAppKeys(this.app,o=>{let r=o.map(a=>a.key);t(r)})}).catch(s=>{e(s)}):this.catalog.getAppKeys(this.app,s=>{let o=s.map(r=>r.key);t(o)})}),"getDatabaseListAsync");this.getCatalogSummary=l(t=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new u(e=>{this.catalog=e,this.getCatalogSummary(t)});return}this.catalog.getAllKeys(e=>{let s=[],o,r,a,n,c;for(let d=0;d<e.length;d++)o=e[d],a=o.app||"",n=o.key||"",c=o.val||"",r=a.length*2+n.length*2+c.length+1,s.push({app:o.app,key:o.key,size:r});typeof t=="function"?t(s):s.forEach(d=>{console.log(d)})})},"getCatalogSummary");if(w&&console.log("Initialized crypted-indexeddb-adapter"),this.app="sylvie",this.options=t||{},typeof(t==null?void 0:t.appname)!="undefined"&&(this.app=t==null?void 0:t.appname),this.catalog=null,!S(this,P,$).call(this))throw new Error("IndexedDB does not seem to be supported for your environment");t.secret&&m(this,p,t.secret)}usePassword(t){m(this,p,t)}saveDatabaseAsync(t,e){return h(this,null,function*(){return new Promise((s,o)=>{let r=l(()=>R(e,A(this,p)).then(n=>{w&&console.debug(`ENCRYPTED STRING: ${n}`),this.catalog.setAppKeyAsync(this.app,t,n).then(c=>{c.success===!0?s(c):o(c)}).catch(c=>{o(c)})}).catch(n=>{o(n)}),"doSave"),a=l(n=>{n==null||typeof n=="object"&&Object.hasOwn(n,"success")&&n&&n.success===!0?s(void 0):o(new Error("Error saving database: "+n)),this.options.closeAfterSave===!0&&A(this,x).call(this)},"afterSaveCallback");this.catalog===null||this.catalog.db===null?new u().initialize().then(n=>{this.catalog=n,this.saveDatabaseAsync(t,e).then(c=>{a(c)}).catch(c=>{a(c)})}).catch(n=>{o(n)}):r()})})}deleteDatabaseAsync(t){return h(this,null,function*(){return new Promise((e,s)=>{let o=l(()=>this.catalog.getAppKeyAsync(this.app,t).then(r=>{let a=r.id;a!==0&&this.catalog.deleteAppKeyAsync(a).then(n=>{n.success===!0?e(n):s(n)}).catch(n=>{s(n)})}).catch(r=>{s(r)}),"doDelete");this.catalog===null||this.catalog.db===null?new u().initialize().then(r=>{this.catalog=r,o()}).catch(r=>{s(r)}):o()})})}changePassword(t,e){return h(this,null,function*(){return new Promise((s,o)=>{this.loadDatabase(t,r=>{let a=A(this,p);m(this,p,e),this.saveDatabase(t,r,n=>{n&&(m(this,p,a),n.success===!0?s():o(n)),s()})})})})}};l(K,"CryptedIndexedDBAdapter"),p=new WeakMap,x=new WeakMap,P=new WeakSet,$=l(function(){return!!(typeof indexedDB!="undefined"&&indexedDB)},"#checkIDBAvailability");typeof window!="undefined"&&Object.assign(window,{IndexedDBAdapter:K,CryptedIndexedDBAdapter:K});export{K as CryptedIndexedDBAdapter};
//# sourceMappingURL=crypted-indexeddb-adapter.js.map
