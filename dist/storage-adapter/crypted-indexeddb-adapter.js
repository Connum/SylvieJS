var L=Object.defineProperty;var d=(s,t)=>L(s,"name",{value:t,configurable:!0});var E=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)};var v=(s,t,e)=>(E(s,t,"read from private field"),e?e.call(s):t.get(s)),x=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},C=(s,t,e,o)=>(E(s,t,"write to private field"),o?o.call(s,e):t.set(s,e),e);var P=(s,t,e)=>(E(s,t,"access private method"),e);var h=(s,t,e)=>new Promise((o,n)=>{var r=c=>{try{i(e.next(c))}catch(l){n(l)}},a=c=>{try{i(e.throw(c))}catch(l){n(l)}},i=c=>c.done?o(c.value):Promise.resolve(c.value).then(r,a);i((e=e.apply(s,t)).next())});function O(s){if(s.length%4!==0)throw new Error("Unable to parse base64 string (invalid length).");let t=s.indexOf("=");if(t!==-1&&t<s.length-2)throw new Error("Unable to parse base64 string (octets).");let e=s.endsWith("==")?2:s.endsWith("=")?1:0,o=s.length,n=new Uint8Array(3*(o/4)),r;for(let a=0,i=0;a<o;a+=4,i+=3)r=S(s.charCodeAt(a))<<18|S(s.charCodeAt(a+1))<<12|S(s.charCodeAt(a+2))<<6|S(s.charCodeAt(a+3)),n[i]=r>>16,n[i+1]=r>>8&255,n[i+2]=r&255;return n.subarray(0,n.length-e)}d(O,"base64ToBytes");var y=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","_","-"],B=(()=>{let t=new Uint8Array(256);for(let e=0;e<256;++e)t[e]=255;return y.forEach((e,o)=>{t[e.charCodeAt(0)]=o}),t["=".charCodeAt(0)]=0,t})();function S(s){if(s>=B.length)throw new Error("Unable to parse base64 string (code beyond length).");let t=B[s];if(t===255)throw new Error("Unable to parse base64 string (invalid code).");return t}d(S,"getBase64Code");function $(s){let t="",e,o=s.length;for(e=2;e<o;e+=3)t+=y[s[e-2]>>2],t+=y[(s[e-2]&3)<<4|s[e-1]>>4],t+=y[(s[e-1]&15)<<2|s[e]>>6],t+=y[s[e]&63];return e===o+1&&(t+=y[s[e-2]>>2],t+=y[(s[e-2]&3)<<4],t+="=="),e===o&&(t+=y[s[e-2]>>2],t+=y[(s[e-2]&3)<<4|s[e-1]>>4],t+=y[(s[e-1]&15)<<2],t+="="),t}d($,"bytesToBase64");var j=d(s=>{let t=new TextEncoder;return window.crypto.subtle.importKey("raw",t.encode(s),"PBKDF2",!1,["deriveKey"])},"getPasswordKey"),V=d((s,t,e)=>window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:25e4,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!1,e),"deriveKey");function I(s,t){return h(this,null,function*(){try{let e=window.crypto.getRandomValues(new Uint8Array(16)),o=window.crypto.getRandomValues(new Uint8Array(12)),n=yield j(t),r=yield V(n,e,["encrypt"]),a=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:o},r,new TextEncoder().encode(s)),i=new Uint8Array(a),c=new Uint8Array(e.byteLength+o.byteLength+i.byteLength);return c.set(e,0),c.set(o,e.byteLength),c.set(i,e.byteLength+o.byteLength),$(c)}catch(e){throw console.log(`Encryption Error - ${e}`),e}})}d(I,"encryptData");function U(s,t){return h(this,null,function*(){try{let e=O(s),o=e.slice(0,16),n=e.slice(16,16+12),r=e.slice(16+12),a=yield j(t),i=yield V(a,o,["decrypt"]),c=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},i,r);return new TextDecoder().decode(c)}catch(e){throw console.log(`Decryption Error - ${e}`),e}})}d(U,"decryptData");var g=class{constructor(t){this.db=null,this.initializeCatalog().then(e=>{typeof t=="function"&&t(e)}).catch(e=>{throw console.log(e),e})}openCatalog(){let t=indexedDB.open("SylvieCatalog",1);return t.onupgradeneeded=({target:e})=>{let o=e.result;if(o.objectStoreNames.contains("SylvieAKV")&&o.deleteObjectStore("SylvieAKV"),!o.objectStoreNames.contains("SylvieAKV")){let n=o.createObjectStore("SylvieAKV",{keyPath:"id",autoIncrement:!0});n.createIndex("app","app",{unique:!1}),n.createIndex("key","key",{unique:!1}),n.createIndex("appkey","appkey",{unique:!0})}},t}initializeCatalog(){return h(this,null,function*(){let t=this,e=this.openCatalog();return new Promise((o,n)=>{e.onsuccess=({target:r})=>{t.db=r.result,o(t)},e.onerror=r=>{n(r)}})})}getAppKeyAsync(t,e){return h(this,null,function*(){let r=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("appkey"),a=`${t},${e}`,i=r.get(a);return new Promise((c,l)=>{i.onsuccess=({target:u})=>{let p=u.result;(p===null||typeof p=="undefined")&&(p={id:0,success:!1}),c(p)},i.onerror=u=>{l(u)}})})}setAppKeyAsync(t,e,o){return h(this,null,function*(){let r=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV"),a=r.index("appkey"),i=`${t},${e}`,c=a.get(i);return new Promise((l,u)=>{c.onsuccess=({target:p})=>{let f=p.result;f==null?f={app:t,key:e,appkey:`${t},${e}`,val:o}:f.val=o;let m=r.put(f);m.onerror=()=>{u({success:!1,error:m.error}),console.error("SylvieCatalog.setAppKey (set) onerror"),console.error(c.error)},m.onsuccess=()=>{l({success:!0})}},c.onerror=()=>{u({success:!1,error:c.error}),console.error("SylvieCatalog.setAppKey (get) onerror"),console.error(c.error)}})})}deleteAppKeyAsync(t){let n=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV").delete(t);return new Promise((r,a)=>{n.onsuccess=()=>{r({success:!0})},n.onerror=i=>{a({success:!1,error:i}),console.error("SylvieCatalog.deleteAppKey raised onerror"),console.error(n.error)}})}getAppKeys(t,e){let r=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("app"),a=IDBKeyRange.only(t),i=r.openCursor(a),c=[];i.onsuccess=((l,u)=>()=>{let p=i.result;if(p){let f=p.value;l.push(f),p.continue()}else typeof u=="function"?u(l):console.log(l)})(c,e),i.onerror=(l=>u=>{typeof l=="function"?l(null):(console.error("SylvieCatalog.getAppKeys raised onerror"),console.error(u))})(e)}getAllKeys(t){let n=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").openCursor(),r=[];n.onsuccess=((a,i)=>()=>{let c=n.result;if(c){let l=c.value;a.push(l),c.continue()}else typeof i=="function"?i(a):console.log(a)})(r,t),n.onerror=(a=>i=>{typeof a=="function"&&a(null)})(t)}};d(g,"SylvieCatalog");var A=typeof window!="undefined"&&!!window.__loki_idb_debug;A&&console.log("DEBUG: Running crypted-indexeddb-adapter in DEBUG mode");if(!window.crypto.subtle)throw alert("Required crypto lib is not availible, are you using SSL?"),new Error("Required crypto lib is not availible");var w,K,D,R,b=class{constructor(t,e){x(this,D);x(this,w,void 0);x(this,K,d(()=>{this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},"#closeDatabase"));this.loadDatabase=d((t,e)=>{if(A&&console.debug("loading database"),this.catalog===null||this.catalog.db===null){this.catalog=new g(o=>{this.catalog=o,this.loadDatabase(t,e)});return}this.catalog.getAppKeyAsync(this.app,t).then(o=>{let{success:n}=o;if(n===!1){e(null);return}else{let{val:r}=o;typeof e=="function"?U(r,v(this,w)).then(i=>{A&&console.debug(`DECRYPTED STRING: ${i}`),e(i)}).catch(i=>{e(i)}):console.log(r)}})},"loadDatabase");this.saveDatabase=d((t,e,o)=>{A&&console.debug(`in saveDatabase(${t}, ${e}, ${o})`);let n=d(r=>{r==null||typeof r=="object"&&Object.hasOwn(r,"success")&&r&&r.success===!0?o(void 0):o(new Error("Error saving database: "+r)),this.options.closeAfterSave===!0&&v(this,K).call(this)},"saveCallback");if(this.catalog===null||this.catalog.db===null){this.catalog=new g(()=>{this.saveDatabase(t,e,n)});return}I(e,v(this,w)).then(r=>{A&&console.debug(`ENCRYPTED STRING: ${r}`),this.catalog.setAppKeyAsync(this.app,t,r).then(a=>{o(a)}).catch(a=>{o(a)})}).catch(r=>{o(r)})},"saveDatabase");this.deleteDatabase=d((t,e)=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new g(o=>{this.catalog=o,this.deleteDatabase(t,e)});return}this.catalog.getAppKeyAsync(this.app,t).then(o=>{let n=o.id;n!==0&&this.catalog.deleteAppKeyAsync(n).then(r=>{typeof e=="function"&&e(r)}).catch(r=>{typeof e=="function"&&e({success:!1,error:r})})}).catch(o=>{typeof e=="function"&&e({success:!1,error:o})})},"deleteDatabase");this.deleteDatabasePartitions=d(t=>{this.getDatabaseList(e=>{e.forEach(o=>{o.startsWith(t)&&this.deleteDatabase(o)})})},"deleteDatabasePartitions");this.getDatabaseList=d(t=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new g(e=>{this.catalog=e,this.getDatabaseList(t)});return}this.catalog.getAppKeys(this.app,e=>{let o=[];for(let n=0;n<e.length;n++)o.push(e[n].key);typeof t=="function"?t(o):o.forEach(n=>{console.log(n)})})},"getDatabaseList");this.getDatabaseListAsync=d(()=>new Promise((t,e)=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new g(o=>{this.catalog=o,this.getDatabaseListAsync()});return}this.catalog.getAppKeys(this.app,o=>{let n=[];for(let r=0;r<o.length;r++)n.push(o[r].key);t(n)})}),"getDatabaseListAsync");this.getCatalogSummary=d(t=>{if(this.catalog===null||this.catalog.db===null){this.catalog=new g(e=>{this.catalog=e,this.getCatalogSummary(t)});return}this.catalog.getAllKeys(e=>{let o=[],n,r,a,i,c;for(let l=0;l<e.length;l++)n=e[l],a=n.app||"",i=n.key||"",c=n.val||"",r=a.length*2+i.length*2+c.length+1,o.push({app:n.app,key:n.key,size:r});typeof t=="function"?t(o):o.forEach(l=>{console.log(l)})})},"getCatalogSummary");if(A&&console.log("Initialized crypted-indexeddb-adapter"),this.app="loki",this.options=e||{},typeof t!="undefined"&&(this.app=t),this.catalog=null,!P(this,D,R).call(this))throw new Error("IndexedDB does not seem to be supported for your environment");e.secret&&C(this,w,e.secret)}setSecret(t){C(this,w,t)}};d(b,"CryptedIndexedDBAdapter"),w=new WeakMap,K=new WeakMap,D=new WeakSet,R=d(function(){return!!(typeof indexedDB!="undefined"&&indexedDB)},"#checkIDBAvailability");typeof window!="undefined"&&Object.assign(window,{IndexedDBAdapter:b,CryptedIndexedDBAdapter:b});export{b as CryptedIndexedDBAdapter};
//# sourceMappingURL=crypted-indexeddb-adapter.js.map
