var ee=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var Pe=Object.getOwnPropertyNames;var $e=Object.prototype.hasOwnProperty;var d=(a,s)=>ee(a,"name",{value:s,configurable:!0}),ve=(a=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(a,{get:(s,e)=>(typeof require<"u"?require:s)[e]}):a)(function(a){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+a+'" is not supported')});var ke=(a,s)=>()=>(a&&(s=a(a=0)),s);var Te=(a,s)=>{for(var e in s)ee(a,e,{get:s[e],enumerable:!0})},ze=(a,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of Pe(s))!$e.call(a,i)&&i!==e&&ee(a,i,{get:()=>s[i],enumerable:!(t=Ae(s,i))||t.enumerable});return a};var Re=a=>ze(ee({},"__esModule",{value:!0}),a);var le=(a,s,e)=>{if(!s.has(a))throw TypeError("Cannot "+e)};var W=(a,s,e)=>(le(a,s,"read from private field"),e?e.call(a):s.get(a)),te=(a,s,e)=>{if(s.has(a))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(a):s.set(a,e)},ce=(a,s,e,t)=>(le(a,s,"write to private field"),t?t.call(a,e):s.set(a,e),e);var ie=(a,s,e)=>(le(a,s,"access private method"),e);var K=(a,s,e)=>new Promise((t,i)=>{var r=l=>{try{o(e.next(l))}catch(c){i(c)}},n=l=>{try{o(e.throw(l))}catch(c){i(c)}},o=l=>l.done?t(l.value):Promise.resolve(l.value).then(r,n);o((e=e.apply(a,s)).next())});var Be={};var Ne,P,J,De=ke(()=>{Ne=typeof window!="undefined"&&!!window.__loki_idb_debug;Ne&&console.log("DEBUG: Running indexeddb-adapter in DEBUG mode");P=class{constructor(s,e){if(this.app="loki",this.options=e||{},typeof s!="undefined"&&(this.app=s),this.catalog=null,!this.checkAvailability())throw new Error("IndexedDB does not seem to be supported for your environment")}closeDatabase(){this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)}checkAvailability(){return!!(typeof indexedDB!="undefined"&&indexedDB)}loadDatabase(s,e){let t=this.app,i=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new J(r=>{i.catalog=r,i.loadDatabase(s,e)});return}this.catalog.getAppKey(t,s,({id:r,val:n})=>{if(typeof e=="function"){if(r===0){e(null);return}e(n)}else console.log(n)})}saveDatabase(s,e,t){let i=this.app,r=this;function n(o){o&&o.success===!0?t(null):t(new Error("Error saving database")),r.options.closeAfterSave&&r.closeDatabase()}if(d(n,"saveCallback"),this.catalog===null||this.catalog.db===null){this.catalog=new J(()=>{r.saveDatabase(s,e,n)});return}this.catalog.setAppKey(i,s,e,n)}deleteDatabase(s,e){let t=this.app,i=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new J(r=>{i.catalog=r,i.deleteDatabase(s,e)});return}this.catalog.getAppKey(t,s,r=>{let n=r.id;n!==0?i.catalog.deleteAppKey(n,e):typeof e=="function"&&e({success:!0})})}deleteDatabasePartitions(s){let e=this;this.getDatabaseList(t=>{t.forEach(i=>{i.startsWith(s)&&e.deleteDatabase(i)})})}getDatabaseList(s){let e=this.app,t=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new J(i=>{t.catalog=i,t.getDatabaseList(s)});return}this.catalog.getAppKeys(e,i=>{let r=[];for(let n=0;n<i.length;n++)r.push(i[n].key);typeof s=="function"?s(r):r.forEach(n=>{console.log(n)})})}getCatalogSummary(s){let e=this.app,t=this;if(this.catalog===null||this.catalog.db===null){this.catalog=new J(i=>{t.catalog=i,t.getCatalogSummary(s)});return}this.catalog.getAllKeys(i=>{let r=[],n,o,l,c,h;for(let u=0;u<i.length;u++)n=i[u],l=n.app||"",c=n.key||"",h=n.val||"",o=l.length*2+c.length*2+h.length+1,r.push({app:n.app,key:n.key,size:o});typeof s=="function"?s(r):r.forEach(u=>{console.log(u)})})}};d(P,"IndexedDBAdapter");P.prototype.loadKey=P.prototype.loadDatabase;P.prototype.saveKey=P.prototype.saveDatabase;P.prototype.deleteKey=P.prototype.deleteDatabase;P.prototype.getKeyList=P.prototype.getDatabaseList;J=class{constructor(s){this.db=null,this.initializeLokiCatalog(s)}initializeLokiCatalog(s){let e=indexedDB.open("SylvieCatalog",1),t=this;e.onupgradeneeded=({target:i})=>{let r=i.result;if(r.objectStoreNames.contains("SylvieAKV")&&r.deleteObjectStore("SylvieAKV"),!r.objectStoreNames.contains("SylvieAKV")){let n=r.createObjectStore("SylvieAKV",{keyPath:"id",autoIncrement:!0});n.createIndex("app","app",{unique:!1}),n.createIndex("key","key",{unique:!1}),n.createIndex("appkey","appkey",{unique:!0})}},e.onsuccess=({target:i})=>{t.db=i.result,typeof s=="function"&&s(t)},e.onerror=i=>{throw i}}getAppKey(s,e,t){let n=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("appkey"),o=`${s},${e}`,l=n.get(o);l.onsuccess=(c=>({target:h})=>{let u=h.result;(u===null||typeof u=="undefined")&&(u={id:0,success:!1}),typeof c=="function"?c(u):console.log(u)})(t),l.onerror=(c=>h=>{if(typeof c=="function")c({id:0,success:!1});else throw h})(t)}getAppKeyById(s,e,t){let n=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").get(s);n.onsuccess=((o,l)=>({target:c})=>{typeof l=="function"?l(c.result,o):console.log(c.result)})(t,e)}setAppKey(s,e,t,i){let n=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV"),o=n.index("appkey"),l=`${s},${e}`,c=o.get(l);c.onsuccess=({target:h})=>{let u=h.result;u==null?u={app:s,key:e,appkey:`${s},${e}`,val:t}:u.val=t;let p=n.put(u);p.onerror=(f=>g=>{typeof f=="function"?f({success:!1}):(console.error("SylvieCatalog.setAppKey (set) onerror"),console.error(c.error))})(i),p.onsuccess=(f=>g=>{typeof f=="function"&&f({success:!0})})(i)},c.onerror=(h=>u=>{typeof h=="function"?h({success:!1}):(console.error("SylvieCatalog.setAppKey (get) onerror"),console.error(c.error))})(i)}deleteAppKey(s,e){let r=this.db.transaction(["SylvieAKV"],"readwrite").objectStore("SylvieAKV").delete(s);r.onsuccess=(n=>o=>{typeof n=="function"&&n({success:!0})})(e),r.onerror=(n=>o=>{typeof n=="function"?n({success:!1}):(console.error("SylvieCatalog.deleteAppKey raised onerror"),console.error(r.error))})(e)}getAppKeys(s,e){let r=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").index("app"),n=IDBKeyRange.only(s),o=r.openCursor(n),l=[];o.onsuccess=((c,h)=>({target:u})=>{let p=u.result;if(p){let f=p.value;c.push(f),p.continue()}else typeof h=="function"?h(c):console.log(c)})(l,e),o.onerror=(c=>h=>{typeof c=="function"?c(null):(console.error("SylvieCatalog.getAppKeys raised onerror"),console.error(h))})(e)}getAllKeys(s){let i=this.db.transaction(["SylvieAKV"],"readonly").objectStore("SylvieAKV").openCursor(),r=[];i.onsuccess=((n,o)=>({target:l})=>{let c=l.result;if(c){let h=c.value;n.push(h),c.continue()}else typeof o=="function"?o(n):console.log(n)})(r,s),i.onerror=(n=>o=>{typeof n=="function"&&n(null)})(s)}};d(J,"SylvieCatalog");typeof window!="undefined"&&Object.assign(window,{IndexedDBAdapter:P})});var Y,se,U=class{constructor(){te(this,Y);this.loadDatabase=d((s,e)=>{ie(this,Y,se).call(this).then(()=>{this.fs.stat(s).then(t=>{t.isFile()&&this.fs.readFile(s,{encoding:"utf8"}).then(i=>{e(i)}).catch(i=>{e(i)})}).catch(t=>{e(t)}).catch(e)})},"loadDatabase");this.saveDatabase=d((s,e,t)=>{ie(this,Y,se).call(this).then(()=>{let i=`${s}~`;this.fs.writeFile(i,e).then(()=>{this.fs.rename(i,s).then(()=>t()).catch(t)}).catch(t)}).catch(t)},"saveDatabase");this.deleteDatabase=d((s,e)=>{ie(this,Y,se).call(this).then(()=>{this.fs.unlink(s).then(()=>e()).catch(t=>{e(t)})}).catch(e)},"deleteDatabase")}};d(U,"FsAdapter"),Y=new WeakSet,se=d(function(){return K(this,null,function*(){if(this.fs===null||this.fs===void 0)try{this.fs=yield import("node:fs/promises")}catch(s){console.error(`FsAdapter - ${s}`)}})},"#initializeFS");function q(a,s,e){if(e===!1)return a[s];let t=s.split("."),i=a;for(;t.length>0;)i=i[t.shift()];return i}d(q,"deepProperty");function we(a,s){if(s=="parse-stringify")return I(a,s);for(var e=[],t=0,i=a.length;t<i;t++)e[t]=I(a[t],s);return e}d(we,"cloneObjectArray");function I(a,s){if(a==null)return null;var e=s||"parse-stringify",t;switch(e){case"parse-stringify":t=JSON.parse(JSON.stringify(a));break;case"shallow":t=Object.create(a.constructor.prototype),Object.keys(a).map(function(r){t[r]=a[r]});break;case"shallow-assign":t=Object.create(a.constructor.prototype),Object.assign(t,a);break;case"shallow-recurse-objects":t=I(a,"shallow");var i=Object.keys(a);i.forEach(function(r){typeof a[r]=="object"&&a[r].constructor.name==="Object"?t[r]=I(a[r],"shallow-recurse-objects"):Array.isArray(a[r])&&(t[r]=we(a[r],"shallow-recurse-objects"))});break;default:break}return t}d(I,"clone");function N(a){Object.isFrozen(a)||Object.freeze(a)}d(N,"freeze");function S(a){var s,e;if(Array.isArray(a)){for(e=0;e<a.length;e++)S(a[e]);N(a)}else if(a!==null&&typeof a=="object"){for(s in a)Object.hasOwn(a,s)&&S(a[s]);N(a)}}d(S,"deepFreeze");function B(a){return Object.isFrozen(a)?I(a,"shallow"):a}d(B,"unFreeze");var m={};Te(m,{copyProperties:()=>Ee,getIn:()=>Fe,resolveTransformObject:()=>Ie,resolveTransformParams:()=>Me});var Ee=d(function(a,s){var e;for(e in a)s[e]=a[e]},"copyProperties"),Ie=d(function(a,s,e){var t,i;if(typeof e!="number"&&(e=0),++e>=10)return a;for(t in a)typeof a[t]=="string"&&a[t].indexOf("[%lktxp]")===0?(i=a[t].substring(8),Object.hasOwn(s,i)&&(a[t]=s[i])):typeof a[t]=="object"&&(a[t]=m.resolveTransformObject(a[t],s,e));return a},"resolveTransformObject"),Me=d(function(a,s){var e,t,i=[];if(typeof s=="undefined")return a;for(e=0;e<a.length;e++)t=I(a[e],"shallow-recurse-objects"),i.push(Ie(t,s));return i},"resolveTransformParams"),Fe=d(function(a,s,e){if(a!=null){if(!e)return a[s];if(typeof s=="string"&&(s=s.split(".")),!Array.isArray(s))throw new Error("path must be a string or array. Found "+typeof s);for(var t=0,i=s.length;a!=null&&t<i;)a=a[s[t++]];return t&&t==i?a:void 0}},"getIn");function ne(a){return a.indexOf(".")!==-1}d(ne,"isDeepProperty");function je(a,s){return a+s}d(je,"add");function xe(a,s){return a-s}d(xe,"sub");function re(a){return a.reduce(je,0)/a.length}d(re,"average");function Se(a){let s=re(a),e=a.map(function(r){let n=r-s;return n*n}),t=re(e);return Math.sqrt(t)}d(Se,"standardDeviation");function he(a){return typeof a=="string"||Array.isArray(a)?function(s){return a.indexOf(s)!==-1}:typeof a=="object"&&a!==null?function(s){return Object.hasOwn(a,s)}:null}d(he,"containsCheckFn");function H(a,s,e,t,i,r){let n=r||0,o=s[n],l=!1,c;if(a!==null&&typeof a=="object"&&o in a&&(c=a[o]),n+1>=s.length)l=e(c,t,i);else if(Array.isArray(c))for(let h=0,u=c.length;h<u&&(l=H(c[h],s,e,t,i,n+1),l!==!0);h+=1);else l=H(c,s,e,t,i,n+1);return l}d(H,"dotSubScan");var b={aeq:ue,lt:de,gt:fe};function ue(a,s){var e,t,i,r;if(a===s)return!0;if(!a||!s||a===!0||s===!0||a!==a||s!==s){switch(a){case void 0:i=1;break;case null:i=1;break;case!1:i=3;break;case!0:i=4;break;case"":i=5;break;default:i=a===a?9:0;break}switch(s){case void 0:r=1;break;case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=s===s?9:0;break}if(i!==9||r!==9)return i===r}return e=Number(a),t=Number(s),e===e||t===t?e===t:(e=a.toString(),t=s.toString(),e==t)}d(ue,"aeqHelper");function de(a,s,e){var t,i,r,n;if(!a||!s||a===!0||s===!0||a!==a||s!==s){switch(a){case void 0:r=1;break;case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=a===a?9:0;break}switch(s){case void 0:n=1;break;case null:n=1;break;case!1:n=3;break;case!0:n=4;break;case"":n=5;break;default:n=s===s?9:0;break}if(r!==9||n!==9)return r===n?e:r<n}return t=Number(a),i=Number(s),t===t&&i===i?t<i?!0:t>i?!1:e:t===t&&i!==i?!0:i===i&&t!==t?!1:a<s?!0:a>s?!1:a==s?e:(t=a.toString(),i=s.toString(),t<i?!0:t==i?e:!1)}d(de,"ltHelper");function fe(a,s,e){var t,i,r,n;if(!a||!s||a===!0||s===!0||a!==a||s!==s){switch(a){case void 0:r=1;break;case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=a===a?9:0;break}switch(s){case void 0:n=1;break;case null:n=1;break;case!1:n=3;break;case!0:n=4;break;case"":n=5;break;default:n=s===s?9:0;break}if(r!==9||n!==9)return r===n?e:r>n}return t=Number(a),i=Number(s),t===t&&i===i?t>i?!0:t<i?!1:e:t===t&&i!==i?!1:i===i&&t!==t||a>s?!0:a<s?!1:a==s?e:(t=a.toString(),i=s.toString(),t>i?!0:t==i?e:!1)}d(fe,"gtHelper");function pe(a,s,e){return b.aeq(a,s)?0:b.lt(a,s,!1)?e?1:-1:b.gt(a,s,!1)?e?-1:1:0}d(pe,"sortHelper");function Ce(a,s,e){for(var t=0,i,r,n,o,l,c=0,h=a.length;c<h;c++)if(i=a[c],r=i[0],~r.indexOf(".")?(l=r.split("."),n=m.getIn(s,l,!0),o=m.getIn(e,l,!0)):(n=s[r],o=e[r]),t=pe(n,o,i[1]),t!==0)return t;return 0}d(Ce,"compoundeval");function L(a,s,e){for(var t in s)if(Object.hasOwn(s,t))return O[t](a,s[t],e);return!1}d(L,"doQueryOp");var O={$eq:function(a,s){return a===s},$aeq:function(a,s){return a==s},$ne:function(a,s){return s!==s?a===a:a!==s},$dteq:function(a,s){return b.aeq(a,s)},$gt:function(a,s){return b.gt(a,s,!1)},$gte:function(a,s){return b.gt(a,s,!0)},$lt:function(a,s){return b.lt(a,s,!1)},$lte:function(a,s){return b.lt(a,s,!0)},$jgt:function(a,s){return a>s},$jgte:function(a,s){return a>=s},$jlt:function(a,s){return a<s},$jlte:function(a,s){return a<=s},$between:function(a,s){return a==null?!1:b.gt(a,s[0],!0)&&b.lt(a,s[1],!0)},$jbetween:function(a,s){return a==null?!1:a>=s[0]&&a<=s[1]},$in:function(a,s){return s.indexOf(a)!==-1},$inSet:function(a,s){return s.has(a)},$nin:function(a,s){return s.indexOf(a)===-1},$keyin:function(a,s){return a in s},$nkeyin:function(a,s){return!(a in s)},$definedin:function(a,s){return s[a]!==void 0},$undefinedin:function(a,s){return s[a]===void 0},$regex:function(a,s){return s.test(a)},$containsString:function(a,s){return typeof a=="string"&&a.indexOf(s)!==-1},$containsNone:function(a,s){return!O.$containsAny(a,s)},$containsAny:function(a,s){var e=he(a);return e!==null?Array.isArray(s)?s.some(e):e(s):!1},$contains:function(a,s){var e=he(a);return e!==null?Array.isArray(s)?s.every(e):e(s):!1},$elemMatch:function(a,s){return Array.isArray(a)?a.some(function(e){return Object.keys(s).every(function(t){var i=s[t];return typeof i=="object"&&i||(i={$eq:i}),t.indexOf(".")!==-1?H(e,t.split("."),L,s[t],e):L(e[t],i,e)})}):!1},$type:function(a,s,e){var t=typeof a;return t==="object"&&(Array.isArray(a)?t="array":a instanceof Date&&(t="date")),typeof s!="object"?t===s:L(t,s,e)},$finite:function(a,s){return s===isFinite(a)},$size:function(a,s,e){return Array.isArray(a)?typeof s!="object"?a.length===s:L(a.length,s,e):!1},$len:function(a,s,e){return typeof a=="string"?typeof s!="object"?a.length===s:L(a.length,s,e):!1},$where:function(a,s){return s(a)===!0},$not:function(a,s,e){return!L(a,s,e)},$and:function(a,s,e){for(var t=0,i=s.length;t<i;t+=1)if(!L(a,s[t],e))return!1;return!0},$or:function(a,s,e){for(var t=0,i=s.length;t<i;t+=1)if(L(a,s[t],e))return!0;return!1},$exists:function(a,s){return s?a!==void 0:a===void 0}},qe=["$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$type"];qe.forEach(function(a){var s=O[a];O["$"+a]=function(e,t,i){if(typeof t=="string")return s(e,i[t]);if(typeof t=="function")return s(e,t(i));throw new Error("Invalid argument to $$ matcher")}});var ae={$eq:O.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0};function ye(a,s){if(a==="$regex")Array.isArray(s)?s=new RegExp(s[0],s[1]):s instanceof RegExp||(s=new RegExp(s));else if(typeof s=="object")for(let e in s)(e==="$regex"||typeof s[e]=="object")&&(s[e]=ye(e,s[e]));return s}d(ye,"precompileQuery");var x=class{constructor(s,e){this.branch=x.prototype.copy;this.$or=x.prototype.findOr;this.$and=x.prototype.findAnd;return this.options=e||{},this.collection=s,this.filteredrows=[],this.filterInitialized=!1,this}reset(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this}toJSON(){let s=this.copy();return s.collection=null,s}limit(s){!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let e=new x(this.collection);return e.filteredrows=this.filteredrows.slice(0,s),e.filterInitialized=!0,e}offset(s){!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let e=new x(this.collection);return e.filteredrows=this.filteredrows.slice(s),e.filterInitialized=!0,e}copy(){let s=new x(this.collection);return this.filteredrows.length>0&&(s.filteredrows=this.filteredrows.slice()),s.filterInitialized=this.filterInitialized,s}transform(s,e){let t,i,r=this;if(typeof s=="string"&&Object.hasOwn(this.collection.transforms,s)&&(s=this.collection.transforms[s]),typeof s!="object"||!Array.isArray(s))throw new Error("Invalid transform");for(typeof e!="undefined"&&(s=m.resolveTransformParams(s,e)),t=0;t<s.length;t++)switch(i=s[t],i.type){case"find":r.find(i.value);break;case"where":r.where(i.value);break;case"simplesort":r.simplesort(i.property,i.desc||i.options);break;case"compoundsort":r.compoundsort(i.value);break;case"sort":r.sort(i.value);break;case"limit":r=r.limit(i.value);break;case"offset":r=r.offset(i.value);break;case"map":r=r.map(i.value,i.dataOptions);break;case"eqJoin":r=r.eqJoin(i.joinData,i.leftJoinKey,i.rightJoinKey,i.mapFun,i.dataOptions);break;case"mapReduce":r=r.mapReduce(i.mapFunction,i.reduceFunction);break;case"update":r.update(i.value);break;case"remove":r.remove();break;default:break}return r}sort(s){!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let e=((t,i)=>(r,n)=>t(i[r],i[n]))(s,this.collection.data);return this.filteredrows.sort(e),this}simplesort(s,e){let t,i=10,r=this.collection.data.length,n=this.filteredrows.length,o=Object.hasOwn(this.collection.binaryIndices,s);if((typeof e=="undefined"||e===!1)&&(e={desc:!1}),e===!0&&(e={desc:!0}),n===0){if(this.filterInitialized)return this;if(Object.hasOwn(this.collection.binaryIndices,s))return this.collection.ensureIndex(s),this.filteredrows=this.collection.binaryIndices[s].values.slice(0),e.desc&&this.filteredrows.reverse(),this;this.filteredrows=this.collection.prepareFullDocIndex()}else if(!e.disableIndexIntersect&&o&&(t=r/n,e.useJavascriptSorting&&(i=6),t<=i||e.forceIndexIntersect)){let c,h=this.filteredrows,u={};for(c=0;c<n;c++)u[h[c]]=!0;let p=this.collection.binaryIndices[s].values;return this.filteredrows=p.filter(f=>u[f]),e.desc&&this.filteredrows.reverse(),this}if(e.useJavascriptSorting)return this.sort((c,h)=>{if(c[s]===h[s])return 0;if(c[s]>h[s])return 1;if(c[s]<h[s])return-1});let l=((c,h,u)=>{let p,f,g;return(y,C)=>(~c.indexOf(".")?(g=c.split("."),p=m.getIn(u[y],g,!0),f=m.getIn(u[C],g,!0)):(p=u[y][c],f=u[C][c]),pe(p,f,h))})(s,e.desc,this.collection.data);return this.filteredrows.sort(l),this}compoundsort(s){if(s.length===0)throw new Error("Invalid call to compoundsort, need at least one property");let e;if(s.length===1)return e=s[0],Array.isArray(e)?this.simplesort(e[0],e[1]):this.simplesort(e,!1);for(let i=0,r=s.length;i<r;i+=1)e=s[i],Array.isArray(e)||(s[i]=[e,!1]);!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let t=((i,r)=>(n,o)=>Ce(i,r[n],r[o]))(s,this.collection.data);return this.filteredrows.sort(t),this}findOr(s){let e=null,t=0,i=0,r=[],n=[],o=0;for(let l=0,c=s.length;l<c;l++)for(e=this.branch().find(s[l]).filteredrows,i=e.length,t=0;t<i;t++)o=e[t],n[o]===void 0&&(n[o]=!0,r.push(o));return this.filteredrows=r,this.filterInitialized=!0,this}findAnd(s){for(let e=0,t=s.length;e<t;e++){if(this.count()===0)return this;this.find(s[e])}return this}find(s,e){if(this.collection.data.length===0)return this.filteredrows=[],this.filterInitialized=!0,this;let t=s||"getAll",i,r,n,o,l,c,h,u=!1,p=[],f=[],g=null;if(e=e||!1,typeof t=="object"){for(i in t)o={},o[i]=t[i],f.push(o),E.call(t,i)&&(r=i,n=t[i]);if(f.length>1)return this.find({$and:f},e)}if(!r||t==="getAll")return e&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=this.collection.data.length>0?[0]:[],this.filterInitialized=!0)),this;if(r==="$and"||r==="$or")return this[r](n),e&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this;if(n===null||typeof n!="object"||n instanceof Date)l="$eq",c=n;else if(typeof n=="object"){for(h in n)if(h in n){l=h,c=n[h];break}}else throw new Error("Do not know what you want to do.");(l==="$regex"||typeof c=="object")&&(c=ye(l,c));let y=r.includes(".");!this.filterInitialized&&this.collection.binaryIndices[r]&&ae[l]&&(this.collection.adaptiveBinaryIndices!==!0&&this.collection.ensureIndex(r),u=!0,g=this.collection.binaryIndices[r]),!u&&l==="$in"&&Array.isArray(c)&&typeof Set!="undefined"&&(c=new Set(c),l="$inSet");let $=O[l];if(typeof $!="function")throw new TypeError('"'+l+'" is not a valid operator');let z=this.collection.data,w=0,k=0,R,Q=0,D;if(this.filterInitialized){if(R=this.filteredrows,k=R.length,y){let j=r.split(".");for(w=0;w<k;w++)if(Q=R[w],D=z[Q],H(D,j,$,c,D)&&(p.push(Q),e))return this.filteredrows=p,this}else for(w=0;w<k;w++)if(Q=R[w],D=z[Q],$(D[r],c,D)&&(p.push(Q),e))return this.filteredrows=p,this}else if(u){let j=this.collection.calculateRange(l,r,c);if(l!=="$in"){for(w=j[0];w<=j[1];w++)if(ae[l]!==!0){if(ae[l](m.getIn(z[g.values[w]],r,y),c)&&(p.push(g.values[w]),e))return this.filteredrows=p,this.filterInitialized=!0,this}else if(p.push(g.values[w]),e)return this.filteredrows=p,this.filterInitialized=!0,this}else for(w=0,k=j.length;w<k;w++)if(p.push(g.values[j[w]]),e)return this.filteredrows=p,this.filterInitialized=!0,this}else if(k=z.length,y){let j=r.split(".");for(w=0;w<k;w++)if(D=z[w],H(D,j,$,c,D)&&(p.push(w),e))return this.filteredrows=p,this.filterInitialized=!0,this}else for(w=0;w<k;w++)if(D=z[w],$(D[r],c,D)&&(p.push(w),e))return this.filteredrows=p,this.filterInitialized=!0,this;return this.filteredrows=p,this.filterInitialized=!0,this}where(s){let e,t=[];if(typeof s=="function")e=s;else throw new TypeError("Argument is not a stored view or a function");if(this.filterInitialized){let i=this.filteredrows.length;for(;i--;)e(this.collection.data[this.filteredrows[i]])===!0&&t.push(this.filteredrows[i]);return this.filteredrows=t,this}else{let i=this.collection.data.length;for(;i--;)e(this.collection.data[i])===!0&&t.push(i);return this.filteredrows=t,this.filterInitialized=!0,this}}count(){return this.filterInitialized?this.filteredrows.length:this.collection.count()}update(s){if(typeof s!="function")throw new TypeError("Argument is not a function");!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex());let e,t=this.filteredrows.length,i=this.collection.data;for(let r=0;r<t;r++)!this.collection.disableFreeze||this.collection.cloneObjects||!this.collection.disableDeltaChangesApi?(e=I(i[this.filteredrows[r]],this.collection.cloneMethod),s(e),this.collection.update(e)):(s(i[this.filteredrows[r]]),this.collection.update(i[this.filteredrows[r]]));return this}remove(){return!this.filterInitialized&&this.filteredrows.length===0&&(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.removeBatchByPositions(this.filteredrows),this.filteredrows=[],this}mapReduce(s,e){return e(this.data().map(s))}eqJoin(s,e,t,i,r){let n=[],o=[],l,c=[],h=typeof e=="function",u=typeof t=="function",p={};n=this.data(r);let f=n.length;if(s instanceof A)o=s.chain().data(r);else if(s instanceof x){let y=new x(new A(""));y.rightData=s.data(r)}else if(Array.isArray(s))o=s;else throw new TypeError("joinData needs to be an array or result set");let g=o.length;for(let y=0;y<g;y++)l=u?t(o[y]):o[y][t],p[l]=o[y];i||(i=d((y,C)=>({left:y,right:C}),"mapFun"));for(let y=0;y<f;y++)l=h?e(n[y]):n[y][e],c.push(i(n[y],p[l]||{}));return this.collection=new A("joinData"),this.collection.insert(c),this.filteredrows=[],this.filterInitialized=!1,this}data(s){var e=[],t=this.collection.data,i,r,n,o;if(s=s||{},s.removeMeta&&!s.forceClones&&(s.forceClones=!0,s.forceCloneMethod=s.forceCloneMethod||"shallow"),!this.collection.disableDeltaChangesApi&&this.collection.disableFreeze&&(s.forceClones=!0,s.forceCloneMethod="parse-stringify"),!this.filterInitialized)if(this.filteredrows.length===0)if(this.collection.cloneObjects||s.forceClones){for(r=t.length,o=s.forceCloneMethod||this.collection.cloneMethod,n=0;n<r;n++)i=I(t[n],o),s.removeMeta&&(delete i.$loki,delete i.meta),e.push(i);return e}else return t.slice();else this.filterInitialized=!0;var l=this.filteredrows;if(r=l.length,this.collection.cloneObjects||s.forceClones)for(o=s.forceCloneMethod||this.collection.cloneMethod,n=0;n<r;n++)i=I(t[l[n]],o),s.removeMeta&&(delete i.$loki,delete i.meta),e.push(i);else for(n=0;n<r;n++)e.push(t[l[n]]);return e}map(s,e){let t=this.data(e).map(s);return this.collection=new A("mappedData"),this.collection.insert(t),this.filteredrows=[],this.filterInitialized=!1,this}};d(x,"ResultSet");var M=class{constructor(){this.addListener=this.on;this.events={};this.asyncListeners=!1}on(s,e){let t;var i=this;return Array.isArray(s)?(s.forEach(r=>{this.on(r,e)}),e):(t=this.events[s],t||(t=this.events[s]=[]),t.push(e),e)}emit(s,e,t){let i;var r=this;if(s&&this.events[s])this.events[s].length&&(i=Array.prototype.slice.call(arguments,1),this.events[s].forEach(n=>{this.asyncListeners?setTimeout(()=>{n.apply(r,i)},1):n.apply(r,i)}));else throw new Error(`No event ${s} defined`)}removeListener(s,e){if(Array.isArray(s)){s.forEach(t=>{this.removeListener(t,e)});return}if(this.events[s]){let t=this.events[s];t.splice(t.indexOf(e),1)}}};d(M,"SylvieEventEmitter");var F=class extends M{constructor(e,t,i){super();this.collection=e,this.name=t,this.rebuildPending=!1,this.options=i||{},Object.hasOwn(this.options,"persistent")||(this.options.persistent=!1),Object.hasOwn(this.options,"sortPriority")||(this.options.sortPriority="passive"),Object.hasOwn(this.options,"minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new x(e),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.collection.disableFreeze||Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,this.events={rebuild:[],filter:[],sort:[]}}getSort(){return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple}rematerialize(e){let t,i,r;e=e||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new x(this.collection),(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)&&(this.sortDirty=!0);let n=Object.isFrozen(this.filterPipeline);if(Object.hasOwn(e,"removeWhereFilters"))for(n&&(this.filterPipeline=this.filterPipeline.slice()),t=this.filterPipeline.length,i=t;i--;)this.filterPipeline[i].type==="where"&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);let o=this.filterPipeline;for(this.filterPipeline=[],t=o.length,r=0;r<t;r++)this.applyFind(o[r].val,o[r].uid);return n&&Object.freeze(this.filterPipeline),this.data(),this.emit("rebuild",this),this}branchResultset(e,t){let i=this.resultset.branch();return typeof e=="undefined"?i:i.transform(e,t)}toJSON(){let e=new F(this.collection,this.name,this.options);return e.resultset=this.resultset,e.resultdata=[],e.resultsdirty=!0,e.filterPipeline=this.filterPipeline,e.sortFunction=this.sortFunction,e.sortCriteria=this.sortCriteria,e.sortCriteriaSimple=this.sortCriteriaSimple||null,e.sortDirty=this.sortDirty,e.collection=null,e}removeFilters(e={}){this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null;let t=Object.isFrozen(this.filterPipeline),i=this.filterPipeline.length>0;this.filterPipeline=[],t&&Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,e.queueSortPhase===!0&&this.queueSortPhase(),i&&this.emit("filter")}applySort(e){return this.sortFunction=e,this.sortCriteria=null,this.sortCriteriaSimple=null,this.queueSortPhase(),this.emit("sort"),this}applySimpleSort(e,t){return this.sortCriteriaSimple={propname:e,options:t||!1},this.collection.disableFreeze||S(this.sortCriteriaSimple),this.sortCriteria=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this}applySortCriteria(e){return this.sortCriteria=e,this.collection.disableFreeze||S(this.sortCriteria),this.sortCriteriaSimple=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this}startTransaction(){return this.cachedresultset=this.resultset.copy(),this}commit(){return this.cachedresultset=null,this}rollback(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this}_indexOfFilterWithId(e){if(typeof e=="string"||typeof e=="number"){for(let t=0,i=this.filterPipeline.length;t<i;t+=1)if(e===this.filterPipeline[t].uid)return t}return-1}_addFilter(e){let t=Object.isFrozen(this.filterPipeline);t&&(this.filterPipeline=this.filterPipeline.slice()),this.collection.disableFreeze||S(e),this.filterPipeline.push(e),t&&Object.freeze(this.filterPipeline),this.resultset[e.type](e.val)}reapplyFilters(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);let e=this.filterPipeline,t=Object.isFrozen(e);this.filterPipeline=[];for(let i=0,r=e.length;i<r;i+=1)this._addFilter(e[i]);return t&&Object.freeze(this.filterPipeline),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this}applyFilter(e){let t=this._indexOfFilterWithId(e.uid);if(t>=0){let i=Object.isFrozen(this.filterPipeline);return i&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline[t]=e,i&&(N(e),Object.freeze(this.filterPipeline)),this.reapplyFilters()}return this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(e),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this}applyFind(e,t){return this.applyFilter({type:"find",val:e,uid:t}),this}applyWhere(e,t){return this.applyFilter({type:"where",val:e,uid:t}),this}removeFilter(e){let t=this._indexOfFilterWithId(e);if(t<0)throw new Error(`Dynamic view does not contain a filter with ID: ${e}`);let i=Object.isFrozen(this.filterPipeline);return i&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline.splice(t,1),i&&Object.freeze(this.filterPipeline),this.reapplyFilters(),this}count(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()}data(e){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data(e)}queueRebuildEvent(){if(this.rebuildPending)return;this.rebuildPending=!0;let e=this;setTimeout(()=>{e.rebuildPending&&(e.rebuildPending=!1,e.emit("rebuild",e))},this.options.minRebuildInterval)}queueSortPhase(){if(this.sortDirty)return;this.sortDirty=!0;let e=this;this.options.sortPriority==="active"?setTimeout(()=>{e.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent()}performSortPhase(e){!this.sortDirty&&!this.resultsdirty||(e=e||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),e.suppressRebuildEvent||this.emit("rebuild",this))}evaluateDocument(e,t){if(!this.resultset.filterInitialized){this.options.persistent&&(this.resultdata=this.resultset.data()),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}let i=this.resultset.filteredrows,r=t?-1:i.indexOf(+e),n=i.length,o=new x(this.collection);o.filteredrows=[e],o.filterInitialized=!0;let l;for(let h=0,u=this.filterPipeline.length;h<u;h++)l=this.filterPipeline[h],o[l.type](l.val);let c=o.filteredrows.length===0?-1:0;if(!(r===-1&&c===-1)){if(r===-1&&c!==-1){i.push(e),this.options.persistent&&this.resultdata.push(this.collection.data[e]),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}if(r!==-1&&c===-1){r<n-1?(i.splice(r,1),this.options.persistent&&this.resultdata.splice(r,1)):(i.length=n-1,this.options.persistent&&(this.resultdata.length=n-1)),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}if(r!==-1&&c!==-1){this.options.persistent&&(this.resultdata[r]=this.collection.data[e]),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}}}removeDocument(e){let t,i,r={},n={},o=[],l=this.resultset,c=this.resultset.filteredrows,h=c.length;if(!this.resultset.filterInitialized){this.options.persistent&&(this.resultdata=this.resultset.data()),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent();return}Array.isArray(e)||(e=[e]);let u=e.length;for(i=0;i<u;i++)r[e[i]]=!0;for(t=0;t<h;t++)r[c[t]]&&(n[t]=!0);Object.keys(n).length>0&&(this.resultset.filteredrows=this.resultset.filteredrows.filter((f,g)=>!n[g]),this.options.persistent&&(this.resultdata=this.resultdata.filter((f,g)=>!n[g])),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());let p=d(f=>g=>g<l.filteredrows[f],"filt");for(h=l.filteredrows.length,t=0;t<h;t++)o=e.filter(p(t)),l.filteredrows[t]-=o.length}mapReduce(e,t){return t(this.data().map(e))}};d(F,"DynamicView");var T,Z=class{constructor(s){te(this,T,void 0);ce(this,T,Object.create(null)),this.field=s}set(s,e){W(this,T)[s]?W(this,T)[s].push(e):W(this,T)[s]=[e]}remove(s,e){let t=W(this,T)[s];for(let i in t)t[i]===e&&t.splice(parseInt(i),1);t.length<1&&(W(this,T)[s]=void 0)}get(s){return W(this,T)[s]}clear(){ce(this,T,{})}};d(Z,"ExactIndex"),T=new WeakMap;var _=class{constructor(s){this.field=s,this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}set(s){let e=s[this.field];if(e!==null&&typeof e!="undefined"){if(this.keyMap[e])throw new Error(`Duplicate key for property ${this.field}: ${e}`);this.keyMap[e]=s,this.lokiMap[s.$loki]=e}}get(s){return this.keyMap[s]}byId(s){return this.keyMap[this.lokiMap[s]]}update(s,e){if(this.lokiMap[s.$loki]!==e[this.field]){let t=this.lokiMap[s.$loki];this.set(e),this.keyMap[t]=void 0}else this.keyMap[s[this.field]]=e}remove(s){let e=this.keyMap[s];if(e!==null&&typeof e!="undefined")this.keyMap[s]=void 0,this.lokiMap[e.$loki]=void 0;else throw new Error(`Key is not in unique index: ${this.field}`)}clear(){this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}};d(_,"UniqueIndex");_.prototype.keyMap={};_.prototype.lokiMap={};function Oe(a){return parseInt(a,10)}d(Oe,"parseBase10");var A=class extends M{constructor(e,t){super();this.stages={};this.commitLog=[];this.configureOptions=d((e={})=>{"adaptiveBinaryIndices"in e&&(this.adaptiveBinaryIndices=e.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},"configureOptions");this.count=d(e=>e?this.chain().find(e).filteredrows.length:this.data.length,"count");this.startTransaction=d(()=>{if(this.transactional){this.cachedData=I(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices,this.cachedDirtyIds=this.dirtyIds;for(let e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].startTransaction()}},"startTransaction");this.commit=d(()=>{if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedDirtyIds=null;for(let e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].commit()}},"commit");this.rollback=d(()=>{if(this.transactional){this.cachedData!==null&&this.cachedIndex!==null&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex,this.dirtyIds=this.cachedDirtyIds);for(let e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].rollback()}},"rollback");this.mapReduce=d((e,t)=>t(this.data.map(e)),"mapReduce");this.lokiConsoleWrapper={log(e){},warn(e){},error(e){}};this.name=e,this.data=[],this.idIndex=null,this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=e,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;let i=this;t=t||{},t.unique&&(Array.isArray(t.unique)||(t.unique=[t.unique]),t.unique.forEach(h=>{i.uniqueNames.push(h)})),t.exact&&t.exact.forEach(h=>{i.constraints.exact[h]=new Z(h)}),this.adaptiveBinaryIndices=Object.hasOwn(t,"adaptiveBinaryIndices")?t.adaptiveBinaryIndices:!0,this.transactional=Object.hasOwn(t,"transactional")?t.transactional:!1,this.cloneObjects=Object.hasOwn(t,"clone")?t.clone:!1,this.cloneMethod=Object.hasOwn(t,"cloneMethod")?t.cloneMethod:"parse-stringify",this.asyncListeners=Object.hasOwn(t,"asyncListeners")?t.asyncListeners:!1,this.disableMeta=Object.hasOwn(t,"disableMeta")?t.disableMeta:!1,this.disableChangesApi=Object.hasOwn(t,"disableChangesApi")?t.disableChangesApi:!0,this.disableDeltaChangesApi=Object.hasOwn(t,"disableDeltaChangesApi")?t.disableDeltaChangesApi:!0,this.disableChangesApi&&(this.disableDeltaChangesApi=!0),this.autoupdate=Object.hasOwn(t,"autoupdate")?t.autoupdate:!1,this.serializableIndices=Object.hasOwn(t,"serializableIndices")?t.serializableIndices:!0,this.disableFreeze=Object.hasOwn(t,"disableFreeze")?t.disableFreeze:!0,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(t.ttl||-1,t.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.dirtyIds=[];let r=[];if(t&&t.indices)if(Object.prototype.toString.call(t.indices)==="[object Array]")r=t.indices;else if(typeof t.indices=="string")r=[t.indices];else throw new TypeError("Indices needs to be a string or an array of strings");for(let h=0;h<r.length;h++)this.ensureIndex(r[h]);function n(h){let u=new Set;u.add||(u.add=function(p){return this.includes(p)||this.push(p),this}),h.forEach(({object:p})=>{u.add(p)}),u.forEach(p=>{if(!E.call(p,"$loki"))return i.removeAutoUpdateObserver(p);try{i.update(p)}catch(f){console.log(f)}})}d(n,"observerCallback"),this.observerCallback=n;function o(h,u){return u?l(u,h):JSON.parse(JSON.stringify(h))}d(o,"getChangeDelta"),this.getChangeDelta=o;function l(h,u){let p=u!==null&&typeof u=="object"?Object.keys(u):null;if(p&&p.length&&!["string","boolean","number"].includes(typeof u)){let f={};for(let g=0;g<p.length;g++){let y=p[g];if(y in u)if(!(y in h)||i.uniqueNames.includes(y)||y=="$loki"||y=="meta")f[y]=u[y];else{let C=l(h[y],u[y]);typeof C!="undefined"&&(f[y]=C)}}return Object.keys(f).length===0?void 0:f}else return h===u?void 0:u}d(l,"getObjectDelta"),this.getObjectDelta=l;function c(){i.changes=[]}d(c,"flushChanges"),this.getChanges=()=>i.changes,this.flushChanges=c,this.setChangesApi=h=>{i.disableChangesApi=!h,h||(i.disableDeltaChangesApi=!1)},this.on("delete",d(function(u){i.disableChangesApi||i.createChange(i.name,"R",u)},"deleteCallback")),this.on("warning",h=>{i.lokiConsoleWrapper.warn(h)}),c()}createChange(e,t,i,r){this.changes.push({name:e,operation:t,obj:t=="U"&&!this.disableDeltaChangesApi?this.getChangeDelta(i,r):JSON.parse(JSON.stringify(i))})}insertMeta(e){let t,i;if(!(this.disableMeta||!e)){if(Array.isArray(e)){for(t=e.length,i=0;i<t;i++)"meta"in e[i]||(e[i].meta={}),e[i].meta.created=new Date().getTime(),e[i].meta.revision=0;return}e.meta||(e.meta={}),e.meta.created=new Date().getTime(),e.meta.revision=0}}updateMeta(e){return this.disableMeta||!e||(this.disableFreeze||(e=B(e),e.meta=B(e.meta)),e.meta.updated=new Date().getTime(),e.meta.revision+=1),e}createInsertChange(e){this.createChange(this.name,"I",e)}createUpdateChange(e,t){this.createChange(this.name,"U",e,t)}insertMetaWithChange(e){this.insertMeta(e),this.createInsertChange(e)}updateMetaWithChange(e,t){return e=this.updateMeta(e),this.createUpdateChange(e,t),e}addAutoUpdateObserver(e){!this.autoupdate||typeof Object.observe!="function"||Object.observe(e,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])}removeAutoUpdateObserver(e){!this.autoupdate||typeof Object.observe!="function"||Object.unobserve(e,this.observerCallback)}addTransform(e,t){if(e in this.transforms)throw new Error("a transform by that name already exists");this.transforms[e]=t}getTransform(e){return this.transforms[e]}setTransform(e,t){this.transforms[e]=t}removeTransform(e){delete this.transforms[e]}byExample(e){let t,i,r=[];for(t in e)t in e&&r.push((i={},i[t]=e[t],i));return{$and:r}}findObject(e){return this.findOne(this.byExample(e))}findObjects(e){return this.find(this.byExample(e))}ttlDaemonFuncGen(){let e=this,t=this.ttl.age;return d(function(){let r=Date.now();e.chain().where(d(function(l){let c=l.meta.updated||l.meta.created,h=r-c;return t<h},"daemonFilter")).remove()},"ttlDaemon")}setTTL(e,t){e<0?clearInterval(this.ttl.daemon):(this.ttl.age=e,this.ttl.ttlInterval=t,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),t))}prepareFullDocIndex(){let e=this.data.length,t=new Array(e);for(let i=0;i<e;i+=1)t[i]=i;return t}ensureIndex(e,t){if(typeof t=="undefined"&&(t=!1),e==null)throw new Error("Attempting to set index without an associated property");if(this.binaryIndices[e]&&!t&&!this.binaryIndices[e].dirty||this.adaptiveBinaryIndices===!0&&e in this.binaryIndices&&!t)return;let i={name:e,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[e]=i;let r=((n,o)=>{let l,c,h=~n.indexOf(".")?n.split("."):!1;return(u,p)=>{if(h?(l=m.getIn(o[u],h,!0),c=m.getIn(o[p],h,!0)):(l=o[u][n],c=o[p][n]),l!==c){if(b.lt(l,c,!1))return-1;if(b.gt(l,c,!1))return 1}return 0}})(e,this.data);i.values.sort(r),i.dirty=!1,this.dirty=!0}checkAllIndexes(e){let t,i=this.binaryIndices,r=[],n;for(t in i)E.call(i,t)&&(n=this.checkIndex(t,e),n||r.push(t));return r}checkIndex(e,t={}){t.randomSamplingFactor&&t.randomSampling!==!1&&(t.randomSampling=!0),t.randomSamplingFactor=t.randomSamplingFactor||.1,(t.randomSamplingFactor<0||t.randomSamplingFactor>1)&&(t.randomSamplingFactor=.1);let i=!0,r,n,o;if(!(e in this.binaryIndices))throw new Error(`called checkIndex on property without an index: ${e}`);this.adaptiveBinaryIndices||this.ensureIndex(e);let l=this.binaryIndices[e].values,c=l.length;if(c!==this.data.length)return t.repair&&this.ensureIndex(e,!0),!1;if(c===0)return!0;let h=e.includes(".");if(c===1)i=l[0]===0;else if(t.randomSampling){if(O.$lte(m.getIn(this.data[l[0]],e,h),m.getIn(this.data[l[1]],e,h))||(i=!1),O.$lte(m.getIn(this.data[l[c-2]],e,h),m.getIn(this.data[l[c-1]],e,h))||(i=!1),i){for(n=Math.floor((c-1)*t.randomSamplingFactor),r=0;r<n-1;r++)if(o=Math.floor(Math.random()*(c-1)),!O.$lte(m.getIn(this.data[l[o]],e,h),m.getIn(this.data[l[o+1]],e,h))){i=!1;break}}}else for(r=0;r<c-1;r++)if(!O.$lte(m.getIn(this.data[l[r]],e,h),m.getIn(this.data[l[r+1]],e,h))){i=!1;break}return!i&&t.repair&&this.ensureIndex(e,!0),i}getBinaryIndexValues(e){let t,i=this.binaryIndices[e].values,r=[];for(t=0;t<i.length;t++)r.push(m.getIn(this.data[i[t]],e,!0));return r}getUniqueIndex(e,t){let i=this.constraints.unique[e];return!i&&t?this.ensureUniqueIndex(e):i}ensureUniqueIndex(e){let t=this.constraints.unique[e];return t||this.uniqueNames.includes(e)||this.uniqueNames.push(e),this.constraints.unique[e]=t=new _(e),this.data.forEach(i=>{t.set(i)}),t}ensureAllIndexes(e){let t=this.binaryIndices;for(let i in t)E.call(t,i)&&this.ensureIndex(i,e)}flagBinaryIndexesDirty(){let e=this.binaryIndices;for(let t in e)E.call(e,t)&&(e[t].dirty=!0)}flagBinaryIndexDirty(e){this.binaryIndices[e]&&(this.binaryIndices[e].dirty=!0)}ensureId(){if(this.idIndex)return;let e=this.data,t=0,i=e.length,r=new Array(i);for(t;t<i;t++)r[t]=e[t].$loki;this.idIndex=r}ensureIdAsync(e){this.async(function(){this.ensureId()},e)}addDynamicView(e,t){let i=new F(this,e,t);return this.DynamicViews.push(i),i}removeDynamicView(e){this.DynamicViews=this.DynamicViews.filter(t=>t.name!==e)}getDynamicView(e){for(let t=0;t<this.DynamicViews.length;t++)if(this.DynamicViews[t].name===e)return this.DynamicViews[t];return null}findAndUpdate(e,t){typeof e=="function"?this.updateWhere(e,t):this.chain().find(e).update(t)}findAndRemove(e){this.chain().find(e).remove()}insert(e,t){if(!Array.isArray(e))return this.insertOne(e);let i,r=[],n=t&&!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;n&&(this.adaptiveBinaryIndices=!1);try{this.emit("pre-insert",e);for(let o=0,l=e.length;o<l;o++){if(i=this.insertOne(e[o],!0),!i)return;r.push(i)}}finally{n&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return this.emit("insert",r),r=this.cloneObjects?I(r,this.cloneMethod):r,r.length===1?r[0]:r}insertOne(e,t){let i=null;if(typeof e!="object"?i=new TypeError("Document needs to be an object"):e===null&&(i=new TypeError("Object cannot be null")),i!==null)throw this.emit("error",i),i;let r=this.cloneObjects?I(e,this.cloneMethod):e;if(this.disableFreeze||(r=B(r)),this.disableMeta||(typeof r.meta=="undefined"?r.meta={revision:0,created:0}:this.disableFreeze||(r.meta=B(r.meta))),t||this.emit("pre-insert",r),!this.add(r))return;this.disableChangesApi?this.insertMeta(r):this.insertMetaWithChange(r),this.disableFreeze||S(r);let n=this.cloneObjects?I(r,this.cloneMethod):r;return t||this.emit("insert",n),this.addAutoUpdateObserver(n),n}clear(e){let t=this;e=e||{},this.data=[],this.idIndex=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,this.constraints={unique:{},exact:{}},e.removeIndices===!0?(this.binaryIndices={},this.uniqueNames=[]):Object.keys(this.binaryIndices).forEach(r=>{t.binaryIndices[r].dirty=!1,t.binaryIndices[r].values=[]})}update(e){let t,i,r;if(Array.isArray(e)){r=e.length,t=!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0,t&&(this.adaptiveBinaryIndices=!1);try{for(i=0;i<r;i+=1)this.update(e[i])}finally{t&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return}if(!E.call(e,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();let n=this.get(e.$loki,!0),o,l=this;if(!n)throw new Error("Trying to update a document not in collection.");let c=n[0],h=n[1];o=this.cloneObjects||!this.disableDeltaChangesApi&&this.disableFreeze?I(e,this.cloneMethod):e,this.emit("pre-update",e),this.uniqueNames.forEach(f=>{l.getUniqueIndex(f,!0).update(c,o)}),this.data[h]=o,o!==e&&this.addAutoUpdateObserver(e);for(let f=0;f<this.DynamicViews.length;f++)this.DynamicViews[f].evaluateDocument(h,!1);let u;if(this.adaptiveBinaryIndices){let f=this.binaryIndices;for(u in f)this.adaptiveBinaryIndexUpdate(h,u)}else this.flagBinaryIndexesDirty();this.idIndex[h]=o.$loki,this.isIncremental&&this.dirtyIds.push(o.$loki),this.commit(),this.dirty=!0,this.disableChangesApi?o=this.updateMeta(o):o=this.updateMetaWithChange(o,c),this.disableFreeze||S(o);let p;return this.cloneObjects?p=I(o,this.cloneMethod):p=o,this.emit("update",p),p}catch(n){throw this.rollback(),this.lokiConsoleWrapper.error(n.message),this.emit("error",n),n}}add(e){if(typeof e!="object")throw new TypeError("Object being added needs to be an object");if(typeof e.$loki!="undefined")throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1);let t=this.maxId;e.$loki=t,this.disableMeta||(e.meta.version=0);for(let n=0,o=this.uniqueNames.length;n<o;n++)this.getUniqueIndex(this.uniqueNames[n],!0).set(e);this.idIndex&&this.idIndex.push(t),this.isIncremental&&this.dirtyIds.push(t),this.data.push(e);let i=this.data.length-1,r=this.DynamicViews.length;for(let n=0;n<r;n++)this.DynamicViews[n].evaluateDocument(i,!0);if(this.adaptiveBinaryIndices){let n=this.binaryIndices;for(let o in n)this.adaptiveBinaryIndexInsert(i,o)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?I(e,this.cloneMethod):e}catch(t){throw this.rollback(),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),t}}updateWhere(e,t){let i=this.where(e),r=0,n;try{for(r;r<i.length;r++)n=t(i[r]),this.update(n)}catch(o){this.rollback(),this.lokiConsoleWrapper.error(o.message)}}removeWhere(e){let t;typeof e=="function"?(t=this.data.filter(e),this.remove(t)):this.chain().find(e).remove()}removeDataOnly(){this.remove(this.data.slice())}removeBatchByPositions(e){let t=e.length,i={},r,n,o,l=Object.keys(this.binaryIndices).length,c=Object.keys(this.constraints.unique).length,h=this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0,u,p=this;try{for(this.startTransaction(),this.ensureId(),o=0;o<t;o++)i[this.idIndex[e[o]]]=!0;if(r=this.DynamicViews.length,r>0||l>0||c>0){if(r>0)for(n=0;n<r;n++)this.DynamicViews[n].removeDocument(e);if(this.adaptiveBinaryIndices&&!h){let f,g=this.binaryIndices;for(f in g)this.adaptiveBinaryIndexRemove(e,f)}else this.flagBinaryIndexesDirty();c&&this.uniqueNames.forEach(f=>{let g=p.getUniqueIndex(f);if(g)for(o=0;o<t;o++)u=p.data[e[o]],u[f]!==null&&u[f]!==void 0&&g.remove(u[f])})}if(!this.disableChangesApi||this.events.delete.length>1)for(o=0;o<t;o++)this.emit("delete",this.data[e[o]]);if(this.data=this.data.filter(({$loki:f})=>!i[f]),this.isIncremental)for(o=0;o<t;o++)this.dirtyIds.push(this.idIndex[e[o]]);this.idIndex=this.idIndex.filter(f=>!i[f]),this.adaptiveBinaryIndices&&h&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),this.adaptiveBinaryIndices=!0),this.commit(),this.dirty=!0}catch(f){return this.rollback(),h&&(this.adaptiveBinaryIndices=!0),this.lokiConsoleWrapper.error(f.message),this.emit("error",f),null}}removeBatch(e){let t=e.length,i=this.data.length,r,n={},o=[];for(r=0;r<i;r++)n[this.data[r].$loki]=r;for(r=0;r<t;r++)typeof e[r]=="object"?o.push(n[e[r].$loki]):o.push(n[e[r]]);this.removeBatchByPositions(o)}remove(e){let t;if(typeof e=="number"?t=this.get(e):t=e,typeof t!="object")throw new Error("Parameter is not an object");if(Array.isArray(t)){this.removeBatch(t);return}if(!E.call(t,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();let i=this.get(t.$loki,!0),r=i[1],n=this;this.uniqueNames.forEach(o=>{if(t[o]!==null&&typeof t[o]!="undefined"){let l=n.getUniqueIndex(o);l&&l.remove(t[o])}});for(let o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].removeDocument(r);if(this.adaptiveBinaryIndices){let o,l=this.binaryIndices;for(o in l)this.adaptiveBinaryIndexRemove(r,o)}else this.flagBinaryIndexesDirty();return this.data.splice(r,1),this.removeAutoUpdateObserver(t),this.idIndex.splice(r,1),this.isIncremental&&this.dirtyIds.push(t.$loki),this.commit(),this.dirty=!0,this.emit("delete",i[0]),this.disableFreeze||(t=B(t)),delete t.$loki,delete t.meta,this.disableFreeze||N(t),t}catch(i){return this.rollback(),this.lokiConsoleWrapper.error(i.message),this.emit("error",i),null}}get(e,t){this.idIndex||this.ensureId();let i=t||!1,r=this.idIndex,n=r.length-1,o=0,l=o+n>>1;if(e=typeof e=="number"?e:parseInt(e,10),isNaN(e))throw new TypeError("Passed id is not an integer");for(;r[o]<r[n];)l=o+n>>1,r[l]<e?o=l+1:n=l;return n===o&&r[o]===e?i?[this.data[o],o]:this.data[o]:null}getBinaryIndexPosition(e,t){let i=m.getIn(this.data[e],t,!0),r=this.binaryIndices[t].values,n=this.calculateRange("$eq",t,i);if(n[0]===0&&n[1]===-1)return null;let o=n[0],l=n[1];for(let c=o;c<=l;c++)if(r[c]===e)return c;return null}adaptiveBinaryIndexInsert(e,t){let i=t.includes("."),r=this.binaryIndices[t].values,n=m.getIn(this.data[e],t,i);this.serializableIndices===!0&&n instanceof Date&&(this.data[e][t]=n.getTime(),n=m.getIn(this.data[e],t));let o=r.length===0?0:this.calculateRangeStart(t,n,!0,i);this.binaryIndices[t].values.splice(o,0,e)}adaptiveBinaryIndexUpdate(e,t){let i,r=this.binaryIndices[t].values,n=r.length;for(i=0;i<n&&r[i]!==e;i++);this.binaryIndices[t].values.splice(i,1),this.adaptiveBinaryIndexInsert(e,t)}adaptiveBinaryIndexRemove(e,t,i){let r=this.binaryIndices[t],n,o,l,c,h={},u,p;if(Array.isArray(e))if(c=e.length,c===1)e=e[0];else{for(l=0;l<c;l++)h[e[l]]=!0;if(r.values=r.values.filter(y=>!h[y]),i===!0)return;let g=e.slice();for(g.sort((y,C)=>y-C),n=r.values.length,o=0;o<n;o++){for(u=r.values[o],p=0,l=0;l<c&&u>g[l];l++)p++;r.values[o]-=p}return}let f=this.getBinaryIndexPosition(e,t);if(f===null)return null;if(r.values.splice(f,1),i!==!0)for(n=r.values.length,o=0;o<n;o++)r.values[o]>e&&r.values[o]--}calculateRangeStart(e,t,i,r){let n=this.data,o=this.binaryIndices[e].values,l=0,c=o.length-1,h=0;if(o.length===0)return-1;for(;l<c;)h=l+c>>1,b.lt(m.getIn(n[o[h]],e,r),t,!1)?l=h+1:c=h;let u=l;return b.aeq(t,m.getIn(n[o[u]],e,r))?u:b.lt(t,m.getIn(n[o[u]],e,r),!1)?i?u:u-1:i?u+1:u}calculateRangeEnd(e,t,i){let r=this.data,n=this.binaryIndices[e].values,o=0,l=n.length-1,c=0;if(n.length===0)return-1;for(;o<l;)c=o+l>>1,b.lt(t,m.getIn(r[n[c]],e,i),!1)?l=c:o=c+1;let h=l;return b.aeq(t,m.getIn(r[n[h]],e,i))?h:b.gt(t,m.getIn(r[n[h]],e,i),!1)?h+1:b.aeq(t,m.getIn(r[n[h-1]],e,i))?h-1:h}calculateRange(e,t,i){let r=this.data,n=this.binaryIndices[t].values,o=0,l=n.length-1,c,h,u,p;if(r.length===0)return[0,-1];let f=t.includes("."),g=m.getIn(r[n[o]],t,f),y=m.getIn(r[n[l]],t,f);switch(e){case"$eq":case"$aeq":if(b.lt(i,g,!1)||b.gt(i,y,!1))return[0,-1];break;case"$dteq":if(b.lt(i,g,!1)||b.gt(i,y,!1))return[0,-1];break;case"$gt":if(b.gt(i,y,!0))return[0,-1];if(b.gt(g,i,!1))return[o,l];break;case"$gte":if(b.gt(i,y,!1))return[0,-1];if(b.gt(g,i,!0))return[o,l];break;case"$lt":if(b.lt(i,g,!0))return[0,-1];if(b.lt(y,i,!1))return[o,l];break;case"$lte":if(b.lt(i,g,!1))return[0,-1];if(b.lt(y,i,!0))return[o,l];break;case"$between":return b.gt(i[0],y,!1)?[0,-1]:b.lt(i[1],g,!1)?[0,-1]:(c=this.calculateRangeStart(t,i[0],!1,f),u=this.calculateRangeEnd(t,i[1],f),c<0&&c++,u>l&&u--,b.gt(m.getIn(r[n[c]],t,f),i[0],!0)||c++,b.lt(m.getIn(r[n[u]],t,f),i[1],!0)||u--,u<c?[0,-1]:[c,u]);case"$in":{let C=[],$=[];for(let z=0,w=i.length;z<w;z++){let k=this.calculateRange("$eq",t,i[z]);for(let R=k[0];R<=k[1];R++)C[R]===void 0&&(C[R]=!0,$.push(R))}return $}}switch(e){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":c=this.calculateRangeStart(t,i,!1,f),h=m.getIn(r[n[c]],t,f);break;default:break}switch(e){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":u=this.calculateRangeEnd(t,i,f),p=m.getIn(r[n[u]],t,f);break;default:break}switch(e){case"$eq":case"$aeq":case"$dteq":return b.aeq(h,i)?[c,u]:[0,-1];case"$gt":return b.aeq(m.getIn(r[n[u]],t,f),i)?[u+1,l]:[u,l];case"$gte":return b.aeq(m.getIn(r[n[c]],t,f),i)?[c,l]:[c+1,l];case"$lt":return b.aeq(m.getIn(r[n[c]],t,f),i)?[o,c-1]:[o,c];case"$lte":return b.aeq(m.getIn(r[n[u]],t,f),i)?[o,u]:[o,u-1];default:return[0,r.length-1]}}by(e,t){let i;if(t===void 0)return i=this,n=>i.by(e,n);let r=this.getUniqueIndex(e,!0).get(t);return this.cloneObjects?I(r,this.cloneMethod):r}findOne(e={}){let t=this.chain().find(e,!0).data();return Array.isArray(t)&&t.length===0?null:this.cloneObjects?I(t[0],this.cloneMethod):t[0]}chain(e,t){let i=new x(this);return typeof e=="undefined"?i:i.transform(e,t)}find(e){return this.chain().find(e).data()}findOneUnindexed(e,t){let i=this.data.length,r;for(;i--;)if(m.getIn(this.data[i],e,!0)===t)return r=this.data[i],r;return null}async(e,t){setTimeout(()=>{if(typeof e=="function")e(),t();else throw new TypeError("Argument passed for async execution is not a function")},0)}where(e){return this.chain().where(e).data()}eqJoin(e,t,i,r,n){return new x(this).eqJoin(e,t,i,r,n)}getStage(e){return this.stages[e]||(this.stages[e]={}),this.stages[e]}stage(e,t){let i=JSON.parse(JSON.stringify(t));return this.getStage(e)[t.$loki]=i,i}commitStage(e,t){let i=this.getStage(e),r,n=new Date().getTime();for(r in i)this.update(i[r]),this.commitLog.push({timestamp:n,message:t,data:JSON.parse(JSON.stringify(i[r]))});this.stages[e]={}}extract(e){let t=0,i=this.data.length,r=ne(e),n=[];for(t;t<i;t+=1)n.push(q(this.data[t],e,r));return n}max(e){return Math.max.apply(null,this.extract(e))}min(e){return Math.min.apply(null,this.extract(e))}maxRecord(e){let t=0,i=this.data.length,r=ne(e),n={index:0,value:void 0},o;for(t;t<i;t+=1)o!==void 0?o<q(this.data[t],e,r)&&(o=q(this.data[t],e,r),n.index=this.data[t].$loki):(o=q(this.data[t],e,r),n.index=this.data[t].$loki);return n.value=o,n}minRecord(e){let t=0,i=this.data.length,r=ne(e),n={index:0,value:void 0},o;for(t;t<i;t+=1)o!==void 0?o>q(this.data[t],e,r)&&(o=q(this.data[t],e,r),n.index=this.data[t].$loki):(o=q(this.data[t],e,r),n.index=this.data[t].$loki);return n.value=o,n}extractNumerical(e){return this.extract(e).map(Oe).filter(Number).filter(t=>!isNaN(t))}avg(e){return re(this.extractNumerical(e))}stdDev(e){return Se(this.extractNumerical(e))}mode(e){let t={};this.extract(e).forEach(l=>{t[l]?t[l]+=1:t[l]=1});let r,n,o;for(n in t)r?r<t[n]&&(o=n):(o=n,r=t[n]);return o}median(e){let t=this.extractNumerical(e);t.sort(xe);let i=Math.floor(t.length/2);return t.length%2?t[i]:(t[i-1]+t[i])/2}};d(A,"Collection");function ge(a,s,e){for(var t=0,i=a.length,r,n;t<i;){if(n=t+i>>1,r=e.apply(null,[s,a[n]]),r===0)return{found:!0,index:n};r<0?i=n:t=n+1}return{found:!1,index:i}}d(ge,"binarySearch");function me(a){return function(s,e){return ge(s,e,a)}}d(me,"BSonSort");function be(){}d(be,"KeyValueStore");be.prototype={keys:[],values:[],sort(a,s){return a<s?-1:a>s?1:0},setSort(a){this.bs=me(a)},bs(){return me(this.sort)},set(a,s){let e=this.bs(this.keys,a);e.found?this.values[e.index]=s:(this.keys.splice(e.index,0,a),this.values.splice(e.index,0,s))},get(a){return this.values[ge(this.keys,a,this.sort).index]}};function oe(){try{return window&&window.localStorage!==void 0&&window.localStorage!==null}catch(a){return!1}}d(oe,"localStorageAvailable");var G=class{loadDatabase(s,e){oe()?e(localStorage.getItem(s)):e(new Error("localStorage is not available"))}saveDatabase(s,e,t){oe()?(localStorage.setItem(s,e),t(null)):t(new Error("localStorage is not available"))}deleteDatabase(s,e){oe()?(localStorage.removeItem(s),e(null)):e(new Error("localStorage is not available"))}};d(G,"LocalStorageAdapter");var X=class{constructor(s){this.hashStore={},this.options=s||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}loadDatabase(s,e){let t=this;this.options.asyncResponses?setTimeout(()=>{t.hashStore.hasOwnProperty(s)?e(t.hashStore[s].value):e(null)},this.options.asyncTimeout):this.hashStore.hasOwnProperty(s)?e(this.hashStore[s].value):e(null)}saveDatabase(s,e,t){let i=this,r;this.options.asyncResponses?setTimeout(()=>{r=i.hashStore.hasOwnProperty(s)?i.hashStore[s].savecount:0,i.hashStore[s]={savecount:r+1,lastsave:new Date,value:e},t()},this.options.asyncTimeout):(r=this.hashStore.hasOwnProperty(s)?this.hashStore[s].savecount:0,this.hashStore[s]={savecount:r+1,lastsave:new Date,value:e},t())}deleteDatabase(s,e){this.hashStore.hasOwnProperty(s)&&delete this.hashStore[s],typeof e=="function"&&e()}};d(X,"MemoryAdapter");function V(a,s){if(this.mode="reference",this.adapter=null,this.options=s||{},this.dbref=null,this.dbname="",this.pageIterator={},a){if(a.mode==="reference")throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=a}else throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=25*1024*1024),this.options.hasOwnProperty("delimiter")||(this.options.delimiter=`$<
`)}d(V,"PartitioningAdapter");V.prototype.loadDatabase=function(a,s){var e=this;this.dbname=a,this.dbref=new v(a),this.adapter.loadDatabase(a,function(t){if(!t){s(t);return}typeof t!="string"&&s(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"));var i=JSON.parse(t);if(e.dbref.loadJSONObject(i),i=null,e.dbref.collections.length===0){s(e.dbref);return}e.pageIterator={collection:0,pageIndex:0},e.loadNextPartition(0,function(){s(e.dbref)})})};V.prototype.loadNextPartition=function(a,s){var e=this.dbname+"."+a,t=this;if(this.options.paging===!0){this.pageIterator.pageIndex=0,this.loadNextPage(s);return}this.adapter.loadDatabase(e,function(i){var r=t.dbref.deserializeCollection(i,{delimited:!0,collectionIndex:a});t.dbref.collections[a].data=r,++a<t.dbref.collections.length?t.loadNextPartition(a,s):s()})};V.prototype.loadNextPage=function(a){var s=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,e=this;this.adapter.loadDatabase(s,function(t){var i=t.split(e.options.delimiter);t="";var r=i.length,n,o=i[r-1]==="";for(o&&(i.pop(),r=i.length,i[r-1]===""&&r===1&&(i.pop(),r=i.length)),n=0;n<r;n++)e.dbref.collections[e.pageIterator.collection].data.push(JSON.parse(i[n])),i[n]=null;i=[],o?++e.pageIterator.collection<e.dbref.collections.length?e.loadNextPartition(e.pageIterator.collection,a):a():(e.pageIterator.pageIndex++,e.loadNextPage(a))})};V.prototype.exportDatabase=function(a,s,e){var t,i=s.collections.length;for(this.dbref=s,this.dbname=a,this.dirtyPartitions=[-1],t=0;t<i;t++)s.collections[t].dirty&&this.dirtyPartitions.push(t);this.saveNextPartition(function(r){e(r)})};V.prototype.saveNextPartition=function(a){var s=this,e=this.dirtyPartitions.shift(),t=this.dbname+(e===-1?"":"."+e);if(this.options.paging&&e!==-1){this.pageIterator={collection:e,docIndex:0,pageIndex:0},this.saveNextPage(function(r){s.dirtyPartitions.length===0?a(r):s.saveNextPartition(a)});return}var i=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:e});this.adapter.saveDatabase(t,i,function(r){if(r){a(r);return}s.dirtyPartitions.length===0?a(null):s.saveNextPartition(a)})};V.prototype.saveNextPage=function(a){var s=this,e=this.dbref.collections[this.pageIterator.collection],t=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,i=0,r=e.data.length,n=this.options.delimiter.length,o="",l="",c=!1,h=!1,u=d(function(f){l="",f&&a(f),c?a(null):(s.pageIterator.pageIndex++,s.saveNextPage(a))},"pageSaveCallback");e.data.length===0&&(c=!0);let p=!1;for(;!p;)c||(o=JSON.stringify(e.data[this.pageIterator.docIndex]),l+=o,i+=o.length,++this.pageIterator.docIndex>=r&&(c=!0)),i>=this.options.pageSize&&(h=!0),(!h||c)&&(l+=this.options.delimiter,i+=n),(c||h)&&(this.adapter.saveDatabase(t,l,u),p=!0)};var v=class extends M{constructor(e,t){super();this.loadDatabaseInternal=d((e,t)=>{let i=t||(l=>{if(l)throw l}),r=d(l=>{let c=!1;try{this.loadJSON(l,e||{}),c=!0}catch(h){i(h)}c&&(i(null),this.emit("loaded",`database ${this.filename} loaded`))},"handleValidDbString"),n=d(l=>{if(!l){i(null),this.emit("loaded",`empty database ${this.filename} loaded`);return}if(l instanceof Error){i(l);return}if(typeof l=="object"){this.loadJSONObject(l,e||{}),i(null),this.emit("loaded",`database ${this.filename} loaded`);return}i({success:!1,error:Error(`unexpected adapter response : ${l}`)})},"handleLoadError"),o=d(l=>{typeof l=="string"?r(l):n(l)},"loadDatabaseCallback");this.persistenceAdapter!==null?"isAsync"in this.persistenceAdapter?this.persistenceAdapter.loadDatabaseAsync(this.filename).then(l=>r(l)).catch(l=>n(l)):this.persistenceAdapter.loadDatabase(this.filename,o):i(new Error("persistenceAdapter not configured"))},"loadDatabaseInternal");this.filename=e||"loki.db",this.collections=[],this.databaseVersion=1.5,this.engineVersion=1.5,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=t&&Object.hasOwn(t,"verbose")?t.verbose:!1,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};let i=d(()=>typeof global!="undefined"&&(global.android||global.NSObject)?"NATIVESCRIPT":typeof window=="undefined"||typeof global!="undefined"&&global.window&&typeof process!="undefined"?"NODEJS":typeof document!="undefined"?!document.URL.includes("http://")&&!document.URL.includes("https://")?"CORDOVA":"BROWSER":"CORDOVA","getENV");t&&Object.hasOwn(t,"env")?this.ENV=t.env:this.ENV=i(),this.ENV==="undefined"&&(this.ENV="NODEJS"),this.configureOptions(t,!0),this.on("init",this.clearChanges)}getIndexedAdapter(){let e;return typeof ve=="function"&&(e=(De(),Re(Be))),e}configureOptions(e,t){let i={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"},r={fs:U,localStorage:G,memory:X};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,typeof e!="undefined"){if(this.options=e,Object.hasOwn(this.options,"persistenceMethod")&&typeof r[e.persistenceMethod]=="function"&&(this.persistenceMethod=e.persistenceMethod,this.persistenceAdapter=new r[e.persistenceMethod]),Object.hasOwn(this.options,"adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=e.adapter,this.options.adapter=null,this.isIncremental=this.persistenceAdapter.mode==="incremental"),e.autoload&&t){let n=this;setTimeout(()=>{n.loadDatabase(e,e.autoloadCallback)},1)}Object.hasOwn(this.options,"autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),Object.hasOwn(this.options,"autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,Object.hasOwn(this.options,"autosaveCallback")?this.autosaveEnable(e,e.autosaveCallback):this.autosaveEnable()),Object.hasOwn(this.options,"throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}Object.hasOwn(this.options,"serializationMethod")||(this.options.serializationMethod="normal"),Object.hasOwn(this.options,"destructureDelimiter")||(this.options.destructureDelimiter=`$<
`),this.persistenceAdapter===null&&(this.persistenceMethod=i[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new r[this.persistenceMethod]))}copy(e){let t=new v(this.filename,{env:"NA"}),i,r;if(e=e||{},t.loadJSONObject(this,{retainDirtyFlags:!0}),e.hasOwnProperty("removeNonSerializable")&&e.removeNonSerializable===!0)for(t.autosaveHandle=null,t.persistenceAdapter=null,i=t.collections.length,r=0;r<i;r++)t.collections[r].constraints=null,t.collections[r].ttl=null;return t}addCollection(e,t){let i,r=this.collections.length;if(t&&t.disableMeta===!0){if(t.disableChangesApi===!1)throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");if(t.disableDeltaChangesApi===!1)throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if(typeof t.ttl=="number"&&t.ttl>0)throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}for(i=0;i<r;i+=1)if(this.collections[i].name===e)return this.collections[i];let n=new A(e,t);return n.isIncremental=this.isIncremental,this.collections.push(n),this.verbose&&(n.lokiConsoleWrapper=console),n}loadCollection(e){if(!e.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(e)}getCollection(e){let t,i=this.collections.length;for(t=0;t<i;t+=1)if(this.collections[t].name===e)return this.collections[t];return this.emit("warning",`collection ${e} not found`),null}renameCollection(e,t){let i=this.getCollection(e);return i&&(i.name=t),i}listCollections(){let e=this.collections.length,t=[];for(;e--;)t.push({name:this.collections[e].name,type:this.collections[e].objType,count:this.collections[e].data.length});return t}removeCollection(e){let t,i=this.collections.length;for(t=0;t<i;t+=1)if(this.collections[t].name===e){let r=new A(e,{}),n=this.collections[t];for(let o in n)n.hasOwnProperty(o)&&r.hasOwnProperty(o)&&(n[o]=r[o]);this.collections.splice(t,1);return}}getName(){return this.name}serializeReplacer(e,t){switch(e){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;case"throttledSavePending":case"throttledCallbacks":return;case"lokiConsoleWrapper":return null;default:return t}}serialize(e={}){switch(e.hasOwnProperty("serializationMethod")||(e.serializationMethod=this.options.serializationMethod),e.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}}serializeDestructured(e){let t,i,r,n,o=[],l;if(e=e||{},e.hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.partitioned===!0&&e.hasOwnProperty("partition")&&e.partition>=0)return this.serializeCollection({delimited:e.delimited,delimiter:e.delimiter,collectionIndex:e.partition});for(l=new v(this.filename),l.loadJSONObject(this),t=0;t<l.collections.length;t++)l.collections[t].data=[];if(e.partitioned===!0&&e.partition===-1)return l.serialize({serializationMethod:"normal"});for(o.push(l.serialize({serializationMethod:"normal"})),l=null,t=0;t<this.collections.length;t++)if(r=this.serializeCollection({delimited:e.delimited,delimiter:e.delimiter,collectionIndex:t}),e.partitioned===!1&&e.delimited===!1){if(!Array.isArray(r))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(n=r.length,i=0;i<n;i++)o.push(r[i]),r[i]=null;o.push("")}else o.push(r);return e.partitioned?(e.delimited,o):e.delimited?(o.push(""),o.join(e.delimiter)):(o.push(""),o)}serializeCollection(e){let t,i=[];if(e=e||{},e.hasOwnProperty("delimited")||(e.delimited=!0),!e.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");let r=this.collections[e.collectionIndex].data.length;for(i=[],t=0;t<r;t++)i.push(JSON.stringify(this.collections[e.collectionIndex].data[t]));return e.delimited?(i.push(""),i.join(e.delimiter)):i}deserializeDestructured(e,t){let i=[],r,n,o=0,l,c=1,h=!1,u,p;if(t=t||{},t.hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.partitioned){if(t.hasOwnProperty("partition"))return t.partition===-1?(n=JSON.parse(e[0]),n):this.deserializeCollection(e[t.partition+1],t);for(n=JSON.parse(e[0]),l=n.collections.length,o=0;o<l;o++)n.collections[o].data=this.deserializeCollection(e[o+1],t);return n}if(t.delimited){if(i=e.split(t.delimiter),e=null,r=i.length,r===0)return null}else i=e;for(n=JSON.parse(i[0]),l=n.collections.length,i[0]=null;!h;)u=i[c],i[c]===""?++o>l&&(h=!0):(p=JSON.parse(i[c]),n.collections[o].data.push(p)),i[c++]=null;return n}deserializeCollection(e,t){let i=[],r;t=t||{},t.hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.delimited?(i=e.split(t.delimiter),i.pop()):i=e;let n=i.length;for(r=0;r<n;r++)i[r]=JSON.parse(i[r]);return i}loadJSON(e,t){let i;if(e.length===0)i={};else switch(this.options.serializationMethod){case"normal":case"pretty":i=JSON.parse(e);break;case"destructured":i=this.deserializeDestructured(e);break;default:i=JSON.parse(e);break}this.loadJSONObject(i,t)}loadJSONObject(e,t){let i=0,r=e.collections?e.collections.length:0,n,o,l,c,h,u;this.name=e.name,e.hasOwnProperty("throttledSaves")&&t&&!t.hasOwnProperty("throttledSaves")&&(this.throttledSaves=e.throttledSaves),this.collections=[];function p({name:f}){let g=t[f],y;return g.proto?(y=g.inflate||m.copyProperties,C=>{let $=new g.proto;return y(C,$),$}):g.inflate}for(d(p,"makeLoader"),i;i<r;i+=1){if(n=e.collections[i],o=this.addCollection(n.name,{disableChangesApi:n.disableChangesApi,disableDeltaChangesApi:n.disableDeltaChangesApi,disableMeta:n.disableMeta,disableFreeze:n.hasOwnProperty("disableFreeze")?n.disableFreeze:!0}),o.adaptiveBinaryIndices=n.hasOwnProperty("adaptiveBinaryIndices")?n.adaptiveBinaryIndices===!0:!1,o.transactional=n.transactional,o.asyncListeners=n.asyncListeners,o.cloneObjects=n.cloneObjects,o.cloneMethod=n.cloneMethod||"parse-stringify",o.autoupdate=n.autoupdate,o.changes=n.changes,o.dirtyIds=n.dirtyIds||[],t&&t.retainDirtyFlags===!0?o.dirty=n.dirty:o.dirty=!1,n.getData){if(t&&t.hasOwnProperty(n.name)||!o.disableFreeze||o.autoupdate)throw new Error(`this collection cannot be loaded lazily: ${n.name}`);o.getData=n.getData,Object.defineProperty(o,"data",{get(){let f=this.getData();return this.getData=null,Object.defineProperty(this,"data",{value:f}),f}})}else if(l=n.data.length,c=0,t&&t.hasOwnProperty(n.name))for(h=p(n),c;c<l;c++)u=h(n.data[c]),o.data[c]=u,o.addAutoUpdateObserver(u),o.disableFreeze||S(o.data[c]);else for(c;c<l;c++)o.data[c]=n.data[c],o.addAutoUpdateObserver(o.data[c]),o.disableFreeze||S(o.data[c]);if(o.maxId=typeof n.maxId=="undefined"?0:n.maxId,typeof n.binaryIndices!="undefined"&&(o.binaryIndices=n.binaryIndices),typeof n.transforms!="undefined"&&(o.transforms=n.transforms),o.uniqueNames=[],n.hasOwnProperty("uniqueNames")&&(o.uniqueNames=n.uniqueNames),typeof n.DynamicViews!="undefined"){for(let f=0;f<n.DynamicViews.length;f++){let g=n.DynamicViews[f],y=o.addDynamicView(g.name,g.options);y.resultdata=g.resultdata,y.resultsdirty=g.resultsdirty,y.filterPipeline=g.filterPipeline,y.sortCriteriaSimple=g.sortCriteriaSimple,y.sortCriteria=g.sortCriteria,y.sortFunction=null,y.sortDirty=g.sortDirty,o.disableFreeze||(S(y.filterPipeline),y.sortCriteriaSimple?S(y.sortCriteriaSimple):y.sortCriteria&&S(y.sortCriteria)),y.resultset.filteredrows=g.resultset.filteredrows,y.resultset.filterInitialized=g.resultset.filterInitialized,y.rematerialize({removeWhereFilters:!0})}e.databaseVersion<1.5&&(o.ensureAllIndexes(!0),o.dirty=!0)}}}close(e){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(e),e=void 0)),e&&this.on("close",e),this.emit("close")}closeAsync(){return K(this,null,function*(){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(yield this.saveDatabaseAsync())),this.emit("close")})}generateChangesNotification(e){function t({name:n}){return n}d(t,"getCollName");let i=[],r=e||this.collections.map(t);return this.collections.forEach(n=>{r.includes(t(n))&&(i=i.concat(n.getChanges()))}),i}serializeChanges(e){return JSON.stringify(this.generateChangesNotification(e))}deserializeChanges(e){return JSON.parse(e)}clearChanges(){this.collections.forEach(e=>{e.flushChanges&&e.flushChanges()})}throttledSaveDrain(e,t){let i=this,r=new Date().getTime();if(this.throttledSaves||e(!0),t=t||{},t.hasOwnProperty("recursiveWait")||(t.recursiveWait=!0),t.hasOwnProperty("recursiveWaitLimit")||(t.recursiveWaitLimit=!1),t.hasOwnProperty("recursiveWaitLimitDuration")||(t.recursiveWaitLimitDuration=2e3),t.hasOwnProperty("started")||(t.started=new Date().getTime()),this.throttledSaves&&this.throttledSavePending)if(t.recursiveWait)this.throttledCallbacks.push(()=>{if(i.throttledSavePending){if(t.recursiveWaitLimit&&r-t.started>t.recursiveWaitLimitDuration){e(!1);return}i.throttledSaveDrain(e,t);return}else{e(!0);return}});else{this.throttledCallbacks.push(e);return}else e(!0)}loadDatabase(e,t){let i=this;if(!this.throttledSaves){this.loadDatabaseInternal(e,t);return}this.throttledSaveDrain(r=>{if(r){i.throttledSavePending=!0,i.loadDatabaseInternal(e,n=>{i.throttledCallbacks.length===0?i.throttledSavePending=!1:i.saveDatabase(),typeof t=="function"&&t(n)});return}else typeof t=="function"&&t(new Error("Unable to pause save throttling long enough to read database"))},e)}loadDatabaseAsync(e){return K(this,null,function*(){return new Promise((t,i)=>{let r=d(l=>t(l),"resolveCallback"),n=d(l=>i(l),"rejectCallback"),o=this;if(!this.throttledSaves){this.loadDatabaseInternal(e,r);return}this.throttledSaveDrain(l=>{if(l){o.throttledSavePending=!0,o.loadDatabaseInternal(e,c=>{o.throttledCallbacks.length===0?o.throttledSavePending=!1:o.saveDatabase(),t(c)});return}else n(new Error("Unable to pause save throttling long enough to read database"))},e)})})}saveDatabaseInternal(e){let t=e||(r=>{if(r)throw r}),i=this;if(!this.persistenceAdapter){t(new Error("persistenceAdapter not configured"));return}if(this.persistenceAdapter.mode==="incremental"){let r;if(this.ignoreAutosave=!0,!("isAsync"in this.persistenceAdapter))this.persistenceAdapter.saveDatabase(this.filename,d(function(){if(i.ignoreAutosave=!1,r){t(new Error("adapter error - getLokiCopy called more than once"));return}let o=i.copy({removeNonSerializable:!0});return r=i.collections.map(({dirty:l,dirtyIds:c})=>[l,c]),i.collections.forEach(l=>{l.dirty=!1,l.dirtyIds=[]}),o},"getLokiCopy"),d(function(o){i.ignoreAutosave=!1,o&&r&&i.collections.forEach((l,c)=>{let h=r[c];l.dirty=l.dirty||h[0],l.dirtyIds=l.dirtyIds.concat(h[1])}),t(o)},"exportDatabaseCallback"));else{t(new Error("Async incremental persistenceAdapter handling not implemented in SylvieJS"));return}}else if(this.persistenceAdapter.mode==="reference")if(!("isAsync"in this.persistenceAdapter)&&this.persistenceAdapter.mode==="reference"&&typeof this.persistenceAdapter.exportDatabase=="function")this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),d(function(n){i.autosaveClearFlags(),t(n)},"exportDatabaseCallback"));else{t(new Error("Async reference persistenceAdapter handling not implemented in SylvieJS"));return}else{this.autosaveClearFlags();let r=d(n=>{t(n)},"afterSaveCallback");"isAsync"in this.persistenceAdapter?this.persistenceAdapter.saveDatabaseAsync(this.filename,this.serialize()).then(r).catch(r):this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),r)}}saveDatabase(e){if(!this.throttledSaves){this.saveDatabaseInternal(e);return}if(this.throttledSavePending){this.throttledCallbacks.push(e);return}let t=this.throttledCallbacks;this.throttledCallbacks=[],t.unshift(e),this.throttledSavePending=!0;let i=this;this.saveDatabaseInternal(r=>{i.throttledSavePending=!1,t.forEach(n=>{typeof n=="function"&&setTimeout(()=>{n(r)},1)}),i.throttledCallbacks.length>0&&i.saveDatabase()})}saveDatabaseAsync(){return K(this,null,function*(){return new Promise(e=>{let t=d(()=>e(),"resolveCallback");if(!this.throttledSaves){this.saveDatabaseInternal(t);return}if(this.throttledSavePending){this.throttledCallbacks.push(t);return}let i=this.throttledCallbacks;this.throttledCallbacks=[],i.unshift(t),this.throttledSavePending=!0;let r=this;this.saveDatabaseInternal(n=>{r.throttledSavePending=!1,i.forEach(o=>{typeof o=="function"&&setTimeout(()=>{o(n)},1)}),r.throttledCallbacks.length>0&&r.saveDatabase()})})})}deleteDatabase(e){let t=e||(i=>{if(i)throw i});if(this.persistenceAdapter!==null){let i=d(r=>{t(r)},"afterDeleteCallback");"isAsync"in this.persistenceAdapter?this.persistenceAdapter.deleteDatabaseAsync(this.filename).then(()=>{i({success:!0})}).catch(r=>{i(r)}):this.persistenceAdapter.deleteDatabase(this.filename,i)}else t(new Error("persistenceAdapter not configured"))}deleteDatabaseAsync(){return K(this,null,function*(){return new Promise((e,t)=>{let i=d(r=>{r instanceof Error?t(r):r!=null&&r.success?e(r):t(r)},"afterDeleteCallback");this.persistenceAdapter!==null?"isAsync"in this.persistenceAdapter?this.persistenceAdapter.deleteDatabaseAsync(this.filename).then(()=>{i({success:!0})}).catch(r=>{i(r)}):this.persistenceAdapter.deleteDatabase(this.filename,i):t(new Error("persistenceAdapter not configured"))})})}autosaveDirty(){for(let e=0;e<this.collections.length;e++)if(this.collections[e].dirty)return!0;return!1}autosaveClearFlags(){for(let e=0;e<this.collections.length;e++)this.collections[e].dirty=!1}autosaveEnable(e,t){this.autosave=!0;let i=5e3,r=this;typeof this.autosaveInterval!="undefined"&&this.autosaveInterval!==null&&(i=this.autosaveInterval),this.autosaveHandle=setInterval(d(function(){r.autosaveDirty()&&!r.ignoreAutosave&&r.saveDatabase(t)},"autosaveHandleInterval"),i)}autosaveDisable(){typeof this.autosaveHandle!="undefined"&&this.autosaveHandle!==null&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)}};d(v,"Sylvie");v.prototype.toJson=v.prototype.serialize;v.prototype.save=v.prototype.saveDatabase;v.deepFreeze=S;v.freeze=N;v.unFreeze=B;v.LokiOps=O;v.Collection=A;v.DynamicView=F;v.Resultset=x;v.KeyValueStore=be;v.LokiMemoryAdapter=X;v.LokiPartitioningAdapter=V;v.LokiLocalStorageAdapter=G;v.LokiFsAdapter=U;v.persistenceAdapters={fs:U,localStorage:G};v.aeq=ue;v.lt=de;v.gt=fe;v.Comparators=b;var E=Object.prototype.hasOwnProperty;typeof window!="undefined"&&Object.assign(window,{loki:v,Sylvie:v});var Hi=v;export{Hi as default,E as hasOwnProperty};
//# sourceMappingURL=sylviejs.js.map
